<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Campanha - RPG System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #0f172a;
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #1e293b;
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid #334155;
        }

        /* HEADER */
        .header {
            background: #111827;
            padding: 20px 30px;
            border-bottom: 1px solid #334155;
        }

        .header h1 {
            color: #fbbf24;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            float: right;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            background: #f59e0b;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #111827;
        }

        /* BOTÃO VOLTAR */
        .back-btn {
            display: inline-block;
            margin-top: 15px;
            color: #94a3b8;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* FORMULÁRIO DE CRIAÇÃO */
        .form-container {
            padding: 30px;
            background: #1e293b;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            color: #fbbf24;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* SUBABAS DA CAMPANHA */
        .subabas-container {
            margin-top: 40px;
            background: #111827;
            border-radius: 10px;
            overflow: hidden;
        }

        .subabas-tabs {
            display: flex;
            background: #0f172a;
            border-bottom: 1px solid #334155;
            overflow-x: auto;
        }

        .subaba-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            white-space: nowrap;
            border-right: 1px solid #334155;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .subaba-tab:hover {
            background: #1e293b;
        }

        .subaba-tab.active {
            background: #1e293b;
            color: #fbbf24;
            border-bottom: 3px solid #fbbf24;
        }

        .subaba-content {
            display: none;
            padding: 30px;
            min-height: 300px;
        }

        .subaba-content.active {
            display: block;
        }

        /* CONTEÚDO DAS SUBABAS */
        .subaba-title {
            color: #fbbf24;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* PERSONAGENS */
        .characters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .character-card {
            background: #334155;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #475569;
        }

        .character-name {
            color: #fbbf24;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .character-class {
            color: #94a3b8;
            font-size: 0.9rem;
        }

        /* NPCs */
        .npcs-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .npc-item {
            background: #334155;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #475569;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .npc-info h4 {
            color: #fbbf24;
            margin-bottom: 5px;
        }

        /* ROLAGENS */
        .dice-history {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .dice-roll {
            background: #334155;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
        }

        /* CHAT */
        .chat-container {
            background: #0f172a;
            border-radius: 8px;
            padding: 20px;
            height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        /* MAPAS */
        .maps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .map-preview {
            background: #334155;
            height: 200px;
            border-radius: 8px;
            border: 1px solid #475569;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
        }

        /* TABELAS */
        .tables-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .table-item {
            background: #334155;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #475569;
        }

        /* BOTÕES */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-secondary {
            background: #334155;
            color: white;
            border: 1px solid #475569;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        .action-buttons {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        /* VALIDAÇÃO DE GUILDA */
        .guild-warning {
            background: #7c2d12;
            color: #fbbf24;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #f59e0b;
        }

        /* MODAL DE BUSCA */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1e293b;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            border: 2px solid #f59e0b;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .campaigns-search-results {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .search-result-item {
            background: #334155;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
        }

        .search-result-item:hover {
            background: #475569;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <h1>
                <i class="fas fa-map"></i>
                Criar Nova Campanha
            </h1>
            <div class="user-info">
                <div class="avatar" id="userAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <span id="playerId">#------</span>
            </div>
        </div>

        <!-- LINK VOLTAR -->
        <div class="form-container">
            <a href="campanhas.html" class="back-btn">
                <i class="fas fa-arrow-left"></i>
                Voltar para Campanhas
            </a>

            <!-- AVISO SE NÃO TEM GUILDA -->
            <div id="guildWarning" class="guild-warning" style="display: none;">
                <h3><i class="fas fa-exclamation-triangle"></i> Aviso Importante!</h3>
                <p>Você precisa estar em uma Guilda para criar uma campanha.</p>
                <a href="guilda.html" class="btn btn-primary" style="margin-top: 10px;">
                    <i class="fas fa-users"></i>
                    Ir para Guilda
                </a>
            </div>

            <!-- FORMULÁRIO DE CRIAÇÃO -->
            <form id="createCampaignForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nome da Campanha *</label>
                        <input type="text" id="campaignName" class="form-control" required
                               placeholder="Ex: A Jornada dos Heróis">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ID da Campanha *</label>
                        <input type="text" id="campaignId" class="form-control" required
                               placeholder="Ex: CAMP001">
                        <small style="color: #94a3b8; display: block; margin-top: 5px;">
                            ID único (será gerado automaticamente se deixar em branco)
                        </small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Guilda *</label>
                        <select id="campaignGuild" class="form-control" required>
                            <option value="">Selecione uma Guilda</option>
                            <!-- Guildas serão preenchidas aqui -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select id="campaignStatus" class="form-control" required>
                            <option value="active">Ativa</option>
                            <option value="paused">Pausada</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cenário</label>
                        <input type="text" id="campaignScenario" class="form-control"
                               placeholder="Ex: Reinos de Ferro, Cyberpunk, etc.">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Capítulo Atual</label>
                        <input type="text" id="campaignChapter" class="form-control"
                               placeholder="Ex: 1 - O Início">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Descrição / História</label>
                    <textarea id="campaignDescription" class="form-control" rows="5"
                              placeholder="Descreva a história da campanha..."></textarea>
                </div>
            </form>

            <!-- SUBABAS DA CAMPANHA -->
            <div class="subabas-container">
                <div class="subabas-tabs">
                    <button class="subaba-tab active" onclick="showSubaba('personagens')">
                        <i class="fas fa-users"></i>
                        Personagens
                    </button>
                    <button class="subaba-tab" onclick="showSubaba('npcs')">
                        <i class="fas fa-robot"></i>
                        NPCs
                    </button>
                    <button class="subaba-tab" onclick="showSubaba('rolagens')">
                        <i class="fas fa-dice"></i>
                        Rolagens
                    </button>
                    <button class="subaba-tab" onclick="showSubaba('chat')">
                        <i class="fas fa-comments"></i>
                        Chat
                    </button>
                    <button class="subaba-tab" onclick="showSubaba('mapas')">
                        <i class="fas fa-map"></i>
                        Mapas
                    </button>
                    <button class="subaba-tab" onclick="showSubaba('tabelas')">
                        <i class="fas fa-table"></i>
                        Tabelas
                    </button>
                </div>

                <!-- SUBABA PERSONAGENS -->
                <div id="subaba-personagens" class="subaba-content active">
                    <h3 class="subaba-title"><i class="fas fa-users"></i> Personagens da Campanha</h3>
                    <div class="characters-grid" id="charactersList">
                        <!-- Personagens serão carregados aqui -->
                        <div class="character-card">
                            <div class="character-name">Você (GM)</div>
                            <div class="character-class">Mestre</div>
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="addCharacter()">
                        <i class="fas fa-plus"></i>
                        Adicionar Personagem
                    </button>
                </div>

                <!-- SUBABA NPCs -->
                <div id="subaba-npcs" class="subaba-content">
                    <h3 class="subaba-title"><i class="fas fa-robot"></i> NPCs da Campanha</h3>
                    <div class="npcs-list" id="npcsList">
                        <!-- NPCs serão carregados aqui -->
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="addNPC()">
                        <i class="fas fa-plus"></i>
                        Adicionar NPC
                    </button>
                </div>

                <!-- SUBABA ROLAGENS -->
                <div id="subaba-rolagens" class="subaba-content">
                    <h3 class="subaba-title"><i class="fas fa-dice"></i> Histórico de Rolagens</h3>
                    <div class="dice-history" id="diceHistory">
                        <!-- Histórico de rolagens -->
                        <div class="dice-roll">
                            <strong>GM</strong> rolou 1d20: <strong>15</strong> (Percepção)
                            <small style="color: #94a3b8; display: block;">há 5 minutos</small>
                        </div>
                    </div>
                </div>

                <!-- SUBABA CHAT -->
                <div id="subaba-chat" class="subaba-content">
                    <h3 class="subaba-title"><i class="fas fa-comments"></i> Chat da Campanha</h3>
                    <div class="chat-container" id="chatBox">
                        <!-- Mensagens do chat -->
                        <div style="color: #94a3b8; text-align: center; margin-top: 50px;">
                            <i class="fas fa-comments fa-2x"></i>
                            <p>Chat da campanha será exibido aqui</p>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" class="form-control" placeholder="Digite uma mensagem...">
                        <button class="btn btn-primary">Enviar</button>
                    </div>
                </div>

                <!-- SUBABA MAPAS -->
                <div id="subaba-mapas" class="subaba-content">
                    <h3 class="subaba-title"><i class="fas fa-map"></i> Mapas da Campanha</h3>
                    <div class="maps-grid" id="mapsList">
                        <!-- Mapas serão carregados aqui -->
                        <div class="map-preview">
                            <i class="fas fa-plus fa-2x"></i>
                            <p>Adicionar Mapa</p>
                        </div>
                    </div>
                </div>

                <!-- SUBABA TABELAS -->
                <div id="subaba-tabelas" class="subaba-content">
                    <h3 class="subaba-title"><i class="fas fa-table"></i> Tabelas da Campanha</h3>
                    <div class="tables-list" id="tablesList">
                        <!-- Tabelas serão carregadas aqui -->
                        <div class="table-item">
                            <h4>Tabela de Tesouros</h4>
                            <p>Itens mágicos e riquezas</p>
                        </div>
                        <div class="table-item">
                            <h4>Tabela de Encontros</h4>
                            <p>Inimigos por nível</p>
                        </div>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="addTable()">
                        <i class="fas fa-plus"></i>
                        Adicionar Tabela
                    </button>
                </div>
            </div>

            <!-- BOTÕES DE AÇÃO -->
            <div class="action-buttons">
                <button class="btn btn-secondary" onclick="cancelCreation()">
                    <i class="fas fa-times"></i>
                    Cancelar
                </button>
                <button class="btn btn-primary" onclick="createCampaign()" id="createBtn">
                    <i class="fas fa-save"></i>
                    Criar Campanha
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Supabase
        const SUPABASE_URL = 'https://pujufdfhaxveuytkneqw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1anVmZGZoYXh2ZXV5dGtuZXF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNTkyODksImV4cCI6MjA3OTkzNTI4OX0.mzOwsmf8qIQ4HZqnXLEmq4D7M6fz4VH1YWpWP-BsFvc';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Estado global
        let currentUser = null;
        let userGuilds = [];
        let campaignData = {
            characters: [],
            npcs: [],
            diceRolls: [],
            maps: [],
            tables: []
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadUserData();
            await loadUserGuilds();
            setupEventListeners();
        });

        // Verificar autenticação
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
            }
            return session;
        }

        // Carregar dados do usuário
        async function loadUserData() {
            const session = await checkAuth();
            const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .single();
            
            if (profile) {
                currentUser = {
                    id: session.user.id,
                    username: profile.username,
                    playerId: profile.player_id
                };
                
                document.getElementById('playerId').textContent = '#' + profile.player_id;
                document.getElementById('userAvatar').textContent = profile.username.charAt(0).toUpperCase();
            }
        }

        // Carregar guildas do usuário
        async function loadUserGuilds() {
            const { data: memberships } = await supabase
                .from('guild_members')
                .select(`
                    guild_id,
                    guilds (id, name, guild_id)
                `)
                .eq('user_id', currentUser.id);
            
            if (memberships && memberships.length > 0) {
                userGuilds = memberships.map(m => m.guilds);
                
                // Preencher select de guildas
                const guildSelect = document.getElementById('campaignGuild');
                userGuilds.forEach(guild => {
                    const option = document.createElement('option');
                    option.value = guild.id;
                    option.textContent = guild.name + ` (${guild.guild_id})`;
                    guildSelect.appendChild(option);
                });
                
                // Esconder aviso se tiver guilda
                document.getElementById('guildWarning').style.display = 'none';
            } else {
                // Mostrar aviso se NÃO tiver guilda
                document.getElementById('guildWarning').style.display = 'block';
                document.getElementById('createBtn').disabled = true;
            }
        }

        // Gerar ID automático
        function generateCampaignId() {
            const timestamp = Date.now().toString().slice(-4);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `CAMP${timestamp}${random}`;
        }

        // Mostrar subaba
        function showSubaba(subaba) {
            // Esconder todas as subabas
            document.querySelectorAll('.subaba-content').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.subaba-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar subaba selecionada
            document.getElementById(`subaba-${subaba}`).classList.add('active');
            document.querySelector(`.subaba-tab[onclick="showSubaba('${subaba}')"]`).classList.add('active');
        }

        // Adicionar personagem
        function addCharacter() {
            const name = prompt("Nome do personagem:");
            if (name) {
                const character = {
                    id: Date.now(),
                    name: name,
                    player: currentUser.username,
                    isGM: true
                };
                campaignData.characters.push(character);
                
                const charactersList = document.getElementById('charactersList');
                const characterCard = document.createElement('div');
                characterCard.className = 'character-card';
                characterCard.innerHTML = `
                    <div class="character-name">${name}</div>
                    <div class="character-class">${currentUser.username}</div>
                `;
                charactersList.appendChild(characterCard);
            }
        }

        // Adicionar NPC
        function addNPC() {
            const name = prompt("Nome do NPC:");
            const role = prompt("Função do NPC:");
            if (name && role) {
                const npc = {
                    id: Date.now(),
                    name: name,
                    role: role,
                    description: ""
                };
                campaignData.npcs.push(npc);
                
                const npcsList = document.getElementById('npcsList');
                const npcItem = document.createElement('div');
                npcItem.className = 'npc-item';
                npcItem.innerHTML = `
                    <div class="npc-info">
                        <h4>${name}</h4>
                        <p>${role}</p>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="removeNPC(${npc.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                npcsList.appendChild(npcItem);
            }
        }

        // Remover NPC
        function removeNPC(npcId) {
            campaignData.npcs = campaignData.npcs.filter(npc => npc.id !== npcId);
            document.getElementById('npcsList').innerHTML = '';
            campaignData.npcs.forEach(npc => {
                const npcsList = document.getElementById('npcsList');
                const npcItem = document.createElement('div');
                npcItem.className = 'npc-item';
                npcItem.innerHTML = `
                    <div class="npc-info">
                        <h4>${npc.name}</h4>
                        <p>${npc.role}</p>
                    </div>
                    <button class="btn btn-secondary btn-small" onclick="removeNPC(${npc.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                npcsList.appendChild(npcItem);
            });
        }

        // Adicionar tabela
        function addTable() {
            const name = prompt("Nome da tabela:");
            const description = prompt("Descrição da tabela:");
            if (name && description) {
                const table = {
                    id: Date.now(),
                    name: name,
                    description: description
                };
                campaignData.tables.push(table);
                
                const tablesList = document.getElementById('tablesList');
                const tableItem = document.createElement('div');
                tableItem.className = 'table-item';
                tableItem.innerHTML = `
                    <h4>${name}</h4>
                    <p>${description}</p>
                `;
                tablesList.appendChild(tableItem);
            }
        }

        // Criar campanha
        async function createCampaign() {
            if (!userGuilds.length) {
                alert('Você precisa estar em uma guilda para criar uma campanha!');
                return;
            }

            const campaignId = document.getElementById('campaignId').value || generateCampaignId();
            const campaignName = document.getElementById('campaignName').value;
            const guildId = document.getElementById('campaignGuild').value;
            
            if (!campaignName || !guildId) {
                alert('Por favor, preencha todos os campos obrigatórios!');
                return;
            }

            try {
                // Verificar se o ID já existe
                const { data: existing } = await supabase
                    .from('campaigns')
                    .select('campaign_id')
                    .eq('campaign_id', campaignId)
                    .single();
                
                if (existing) {
                    alert('Este ID de campanha já está em uso! Por favor, escolha outro.');
                    return;
                }

                // Criar campanha no banco
                const { data: campaign, error } = await supabase
                    .from('campaigns')
                    .insert([{
                        campaign_id: campaignId,
                        name: campaignName,
                        description: document.getElementById('campaignDescription').value,
                        scenario: document.getElementById('campaignScenario').value,
                        chapter: document.getElementById('campaignChapter').value,
                        status: document.getElementById('campaignStatus').value,
                        guild_id: guildId,
                        gm_id: currentUser.id
                    }])
                    .select()
                    .single();
                
                if (error) throw error;

                // Adicionar GM como participante
                await supabase
                    .from('campaign_participants')
                    .insert([{
                        campaign_id: campaignId,
                        user_id: currentUser.id,
                        role: 'gm'
                    }]);

                // Salvar dados extras (NPCs, etc)
                await saveCampaignData(campaignId);

                alert(`Campanha "${campaignName}" criada com sucesso!\nID: ${campaignId}`);
                window.location.href = `campanha-detalhes.html?id=${campaignId}`;

            } catch (error) {
                console.error('Erro ao criar campanha:', error);
                alert('Erro ao criar campanha: ' + error.message);
            }
        }

        // Salvar dados extras da campanha
        async function saveCampaignData(campaignId) {
            // Aqui você pode salvar NPCs, personagens, etc em tabelas separadas
            console.log('Salvando dados extras para campanha:', campaignId, campaignData);
            
            // Exemplo: Salvar NPCs
            for (const npc of campaignData.npcs) {
                await supabase
                    .from('campaign_npcs')
                    .insert([{
                        campaign_id: campaignId,
                        name: npc.name,
                        role: npc.role,
                        description: npc.description
                    }]);
            }
        }

        // Cancelar criação
        function cancelCreation() {
            if (confirm('Deseja cancelar a criação da campanha? Todas as alterações serão perdidas.')) {
                window.location.href = 'campanhas.html';
            }
        }

        // Configurar eventos
        function setupEventListeners() {
            // Gerar ID automático se campo estiver vazio
            document.getElementById('campaignId').addEventListener('blur', function() {
                if (!this.value.trim()) {
                    this.value = generateCampaignId();
                }
            });
        }
    </script>
</body>
</html>