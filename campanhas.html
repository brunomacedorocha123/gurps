<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Criar e Gerenciar Campanhas - RPG System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  body {
    background: #0f172a;
    color: white;
    min-height: 100vh;
    padding: 20px;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    background: #1e293b;
    border-radius: 15px;
    overflow: hidden;
    border: 1px solid #334155;
  }

  /* HEADER SIMPLES */
  .header {
    background: #111827;
    padding: 20px 30px;
    border-bottom: 1px solid #334155;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .header-left h1 {
    color: #fbbf24;
    display: flex;
    align-items: center;
    gap: 15px;
    font-size: 24px;
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .avatar {
    width: 40px;
    height: 40px;
    background: #f59e0b;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #111827;
  }

  /* BOTÃO VOLTAR */
  .back-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: #94a3b8;
    text-decoration: none;
    margin-bottom: 20px;
    padding: 8px 16px;
    border-radius: 6px;
    background: rgba(148, 163, 184, 0.1);
  }

  .back-btn:hover {
    background: rgba(148, 163, 184, 0.2);
  }

  /* BOTÃO CRIAR NO TOPO */
  .top-create-btn {
    background: linear-gradient(45deg, #f59e0b, #d97706);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    margin-left: auto;
    margin-right: 20px;
  }

  /* SUBABAS NO TOPO */
  .subabas-top {
    background: #0f172a;
    border-bottom: 1px solid #334155;
    display: flex;
    overflow-x: auto;
    padding: 0 10px;
  }

  .subaba-tab-top {
    padding: 15px 25px;
    background: none;
    border: none;
    color: #94a3b8;
    cursor: pointer;
    white-space: nowrap;
    border-bottom: 3px solid transparent;
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 500;
    font-size: 15px;
  }

  .subaba-tab-top:hover {
    background: rgba(148, 163, 184, 0.1);
  }

  .subaba-tab-top.active {
    color: #fbbf24;
    border-bottom: 3px solid #fbbf24;
    background: rgba(245, 158, 11, 0.1);
  }

  /* CONTEÚDO PRINCIPAL */
  .main-content {
    padding: 30px;
  }

  /* GUILDA INFO */
  .guild-info {
    background: rgba(245, 158, 11, 0.1);
    padding: 15px 20px;
    border-radius: 10px;
    margin-bottom: 25px;
    border-left: 4px solid #f59e0b;
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .guild-info i {
    color: #fbbf24;
    font-size: 20px;
  }

  /* FORMULÁRIO */
  .form-section {
    background: #1e293b;
    border-radius: 10px;
    padding: 25px;
    margin-bottom: 30px;
    border: 1px solid #334155;
  }

  .form-title {
    color: #fbbf24;
    margin-bottom: 20px;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    color: #e2e8f0;
    margin-bottom: 8px;
    font-weight: 500;
  }

  .form-control {
    width: 100%;
    padding: 12px 15px;
    background: #334155;
    border: 1px solid #475569;
    border-radius: 8px;
    color: white;
    font-size: 15px;
  }

  textarea.form-control {
    min-height: 150px;
    resize: vertical;
  }

  .form-full {
    grid-column: 1 / -1;
  }

  /* CONTEÚDO DAS SUBABAS */
  .subaba-content {
    background: #1e293b;
    border-radius: 10px;
    padding: 25px;
    margin-top: 20px;
    border: 1px solid #334155;
    display: none;
  }

  .subaba-content.active {
    display: block;
  }

  .subaba-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
  }

  .subaba-header h3 {
    color: #fbbf24;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  /* ============================================
    NOVA ABA: MINHAS CAMPANHAS - ESTILOS
    ============================================ */
  .campaigns-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
  }

  .campaign-card {
    background: #334155;
    border-radius: 10px;
    padding: 20px;
    border: 1px solid #475569;
    transition: transform 0.2s, border-color 0.2s;
    position: relative;
    cursor: pointer;
  }

  .campaign-card:hover {
    transform: translateY(-2px);
    border-color: #f59e0b;
  }

  .campaign-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 15px;
  }

  .campaign-name {
    color: #fbbf24;
    font-weight: 600;
    font-size: 18px;
    margin-bottom: 5px;
  }

  .campaign-id {
    color: #94a3b8;
    font-size: 14px;
    font-family: monospace;
    background: rgba(0, 0, 0, 0.2);
    padding: 2px 6px;
    border-radius: 4px;
  }

  .campaign-description {
    color: #cbd5e1;
    font-size: 14px;
    line-height: 1.5;
    margin-bottom: 15px;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .campaign-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #475569;
  }

  .campaign-status {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
  }

  .status-active {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.3);
  }

  .status-paused {
    background: rgba(234, 179, 8, 0.2);
    color: #eab308;
    border: 1px solid rgba(234, 179, 8, 0.3);
  }

  .status-finished {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
    border: 1px solid rgba(239, 68, 68, 0.3);
  }

  .campaign-meta {
    display: flex;
    gap: 10px;
    font-size: 12px;
    color: #94a3b8;
  }

  .campaign-meta-item {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #94a3b8;
  }

  .empty-state i {
    font-size: 48px;
    margin-bottom: 20px;
    opacity: 0.5;
  }

  .empty-state h4 {
    color: #e2e8f0;
    margin-bottom: 10px;
  }

  .empty-state p {
    margin-bottom: 20px;
  }

  /* PERSONAGENS */
  .characters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
  }

  .character-card {
    background: #334155;
    padding: 20px;
    border-radius: 10px;
    border: 1px solid #475569;
  }

  .character-name {
    color: #fbbf24;
    font-weight: 600;
    margin-bottom: 5px;
    font-size: 16px;
  }

  .character-class {
    color: #94a3b8;
    font-size: 14px;
  }

  /* NPCs */
  .npcs-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .npc-item {
    background: #334155;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #475569;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .npc-info h4 {
    color: #fbbf24;
    margin-bottom: 5px;
    font-size: 16px;
  }

  .npc-info p {
    color: #94a3b8;
    font-size: 14px;
  }

  /* ROLAGENS */
  .dice-history {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .dice-roll {
    background: #334155;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #f59e0b;
  }

  /* BOTÕES */
  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
  }

  .btn-primary {
    background: #f59e0b;
    color: white;
  }

  .btn-secondary {
    background: #334155;
    color: white;
    border: 1px solid #475569;
  }

  .btn-small {
    padding: 6px 12px;
    font-size: 13px;
  }

  .btn-danger {
    background: #dc2626;
    color: white;
  }

  .btn-success {
    background: #16a34a;
    color: white;
  }

  /* MODAL DE ADICIONAR */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal-content {
    background: #1e293b;
    border-radius: 10px;
    width: 100%;
    max-width: 500px;
    border: 2px solid #f59e0b;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal-header {
    padding: 20px;
    border-bottom: 1px solid #334155;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    background: #1e293b;
    z-index: 1;
  }

  .modal-header h3 {
    color: #fbbf24;
  }

  .modal-close {
    background: none;
    border: none;
    color: #94a3b8;
    font-size: 20px;
    cursor: pointer;
    padding: 5px;
  }

  .modal-body {
    padding: 20px;
  }

  .modal-footer {
    padding: 20px;
    border-top: 1px solid #334155;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    position: sticky;
    bottom: 0;
    background: #1e293b;
  }

  /* CAMPO ID */
  .campaign-id-field {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .campaign-id-field input {
    flex: 1;
  }

  .generate-id-btn {
    background: #475569;
    color: white;
    border: none;
    padding: 12px 15px;
    border-radius: 8px;
    cursor: pointer;
    white-space: nowrap;
  }

  /* LOADING SPINNER */
  .loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #f59e0b;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* ============================================
    AJUSTES ESPECÍFICOS PARA MOBILE (max-width: 768px)
    ============================================ */
  @media (max-width: 768px) {
    body {
      padding: 0;
    }
    
    .container {
      border-radius: 0;
      border: none;
      min-height: 100vh;
    }
    
    /* HEADER MOBILE */
    .header {
      padding: 12px 15px;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .header-left {
      order: 1;
      flex: 1 1 100%;
    }
    
    .header-left h1 {
      font-size: 18px;
      gap: 8px;
    }
    
    .header-left h1 i {
      font-size: 20px;
    }
    
    .top-create-btn {
      order: 2;
      margin: 0;
      padding: 10px 15px;
      font-size: 14px;
      flex: 1;
      justify-content: center;
    }
    
    .user-info {
      order: 3;
      margin-left: auto;
    }
    
    .avatar {
      width: 32px;
      height: 32px;
      font-size: 14px;
    }
    
    /* SUBABAS MOBILE */
    .subabas-top {
      padding: 0 5px;
    }
    
    .subaba-tab-top {
      padding: 12px 15px;
      font-size: 13px;
      gap: 6px;
    }
    
    .subaba-tab-top i {
      font-size: 14px;
    }
    
    /* CONTEÚDO PRINCIPAL MOBILE */
    .main-content {
      padding: 15px;
    }
    
    .back-btn {
      padding: 8px 12px;
      font-size: 14px;
      margin-bottom: 15px;
    }
    
    /* FORMULÁRIO MOBILE */
    .form-grid {
      grid-template-columns: 1fr;
      gap: 15px;
    }
    
    .form-section {
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .form-title {
      font-size: 16px;
      margin-bottom: 15px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    textarea.form-control {
      min-height: 120px;
      font-size: 14px;
    }
    
    .form-control {
      padding: 10px 12px;
      font-size: 14px;
    }
    
    /* CAMPO ID MOBILE */
    .campaign-id-field {
      flex-direction: column;
      gap: 8px;
      align-items: stretch;
    }
    
    .campaign-id-field input {
      width: 100%;
    }
    
    .generate-id-btn {
      padding: 10px;
      width: 100%;
    }
    
    /* GUILDA INFO MOBILE */
    .guild-info {
      padding: 12px 15px;
      margin-bottom: 20px;
      font-size: 14px;
      gap: 10px;
    }
    
    /* SUBABA CONTENT MOBILE */
    .subaba-content {
      padding: 15px;
      margin-top: 15px;
    }
    
    .subaba-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .subaba-header h3 {
      font-size: 16px;
      width: 100%;
    }
    
    .btn {
      width: 100%;
      justify-content: center;
      padding: 12px;
    }
    
    /* MINHAS CAMPANHAS MOBILE */
    .campaigns-grid {
      grid-template-columns: 1fr;
      gap: 15px;
    }
    
    .campaign-card {
      padding: 15px;
    }
    
    .campaign-footer {
      flex-direction: column;
      gap: 10px;
      align-items: flex-start;
    }
    
    /* PERSONAGENS MOBILE */
    .characters-grid {
      grid-template-columns: 1fr;
      gap: 12px;
    }
    
    .character-card {
      padding: 15px;
    }
    
    /* NPCs MOBILE */
    .npc-item {
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
      padding: 12px;
    }
    
    .npc-info {
      width: 100%;
    }
    
    /* MODAL MOBILE */
    .modal {
      padding: 10px;
      align-items: flex-start;
      padding-top: 20px;
    }
    
    .modal-content {
      max-height: 85vh;
      margin-top: auto;
      margin-bottom: auto;
    }
    
    .modal-body {
      padding: 15px;
    }
    
    .modal-footer {
      padding: 15px;
      flex-direction: column;
    }
    
    .modal-footer .btn {
      width: 100%;
    }
    
    /* BOTÕES EM GERAL */
    .btn-small {
      width: auto;
      align-self: flex-end;
    }
  }
  
  /* ============================================
    AJUSTES PARA TELAS MUITO PEQUENAS (max-width: 480px)
    ============================================ */
  @media (max-width: 480px) {
    .subaba-tab-top {
      padding: 10px 12px;
      font-size: 12px;
    }
    
    .subaba-tab-top span {
      display: none;
    }
    
    .subaba-tab-top i {
      font-size: 16px;
      margin: 0;
    }
    
    .header-left h1 span {
      font-size: 16px;
    }
    
    .top-create-btn span {
      display: none;
    }
    
    .top-create-btn i {
      margin: 0;
      font-size: 16px;
    }
    
    .user-info span {
      display: none;
    }
    
    textarea.form-control {
      min-height: 100px;
    }
  }
  
  /* ============================================
    AJUSTES PARA TABLETS (769px - 1024px)
    ============================================ */
  @media (min-width: 769px) and (max-width: 1024px) {
    .main-content {
      padding: 20px;
    }
    
    .form-grid {
      grid-template-columns: 1fr;
    }
    
    .campaigns-grid {
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }
    
    .characters-grid {
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
  }
</style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <div class="header">
      <div class="header-left">
        <h1>
          <i class="fas fa-map"></i>
          Criar Nova Campanha
        </h1>
      </div>
      <button class="top-create-btn" id="createCampaignBtn">
        <i class="fas fa-save"></i>
        Criar Campanha
      </button>
      <div class="user-info">
        <div class="avatar" id="userAvatar">
          <i class="fas fa-user"></i>
        </div>
        <span id="playerId">#------</span>
      </div>
    </div>

    <!-- SUBABAS NO TOPO -->
    <div class="subabas-top">
      <button class="subaba-tab-top active" onclick="showSubaba('info')">
        <i class="fas fa-info-circle"></i>
        Informações
      </button>
      <button class="subaba-tab-top" onclick="showSubaba('personagens')">
        <i class="fas fa-users"></i>
        Personagens
      </button>
      <button class="subaba-tab-top" onclick="showSubaba('npcs')">
        <i class="fas fa-robot"></i>
        NPCs
      </button>
      <button class="subaba-tab-top" onclick="showSubaba('rolagens')">
        <i class="fas fa-dice"></i>
        Rolagens
      </button>
      <button class="subaba-tab-top" onclick="showSubaba('chat')">
        <i class="fas fa-comments"></i>
        Chat
      </button>
      <button class="subaba-tab-top" onclick="showSubaba('mapas')">
        <i class="fas fa-map"></i>
        Mapas
      </button>
      <button class="subaba-tab-top" onclick="showSubaba('tabelas')">
        <i class="fas fa-table"></i>
        Tabelas
      </button>
      <!-- NOVA ABA: MINHAS CAMPANHAS -->
      <button class="subaba-tab-top" onclick="showSubaba('minhas-campanhas')">
        <i class="fas fa-bookmark"></i>
        Minhas Campanhas
      </button>
    </div>

    <!-- CONTEÚDO PRINCIPAL -->
    <div class="main-content">
      <a href="index.html" class="back-btn">
        <i class="fas fa-arrow-left"></i>
        Voltar para Dashboard
      </a>

      <!-- INFO DA GUILDA -->
      <div id="guildInfo" class="guild-info">
        <i class="fas fa-users"></i>
        <div>
          <strong>Guilda:</strong>
          <span id="currentGuildName">Carregando...</span>
        </div>
      </div>

      <!-- SUBABA: INFORMAÇÕES -->
      <div id="subaba-info" class="subaba-content active">
        <div class="form-section">
          <h3 class="form-title"><i class="fas fa-edit"></i> Informações da Campanha</h3>
          
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Nome da Campanha *</label>
              <input type="text" id="campaignName" class="form-control" required
                  placeholder="Ex: A Jornada dos Heróis">
            </div>
            
            <div class="form-group">
              <label class="form-label">ID da Campanha *</label>
              <div class="campaign-id-field">
                <input type="text" id="campaignId" class="form-control" required
                    placeholder="Será gerado automaticamente">
                <button type="button" class="generate-id-btn" onclick="generateCampaignId()">
                  <i class="fas fa-sync-alt"></i> Gerar
                </button>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Status *</label>
              <select id="campaignStatus" class="form-control" required>
                <option value="active">Ativa</option>
                <option value="paused">Pausada</option>
                <option value="finished">Finalizada</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Capítulo Atual</label>
              <input type="text" id="campaignChapter" class="form-control"
                  placeholder="Ex: Capítulo 1 - O Início">
            </div>

            <div class="form-group">
              <label class="form-label">Cenário</label>
              <input type="text" id="campaignScenario" class="form-control"
                  placeholder="Ex: Reinos de Ferro, Cyberpunk, etc.">
            </div>

            <div class="form-group">
              <label class="form-label">Guilda Vinculada *</label>
              <select id="campaignGuild" class="form-control" required>
                <option value="">Selecione uma Guilda</option>
              </select>
            </div>

            <div class="form-group form-full">
              <label class="form-label">Descrição / História</label>
              <textarea id="campaignDescription" class="form-control" rows="5"
                   placeholder="Descreva a história da campanha..."></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- SUBABA: PERSONAGENS -->
      <div id="subaba-personagens" class="subaba-content">
        <div class="subaba-header">
          <h3><i class="fas fa-users"></i> Personagens da Campanha</h3>
          <button class="btn btn-primary" onclick="showAddCharacterModal()">
            <i class="fas fa-plus"></i>
            Adicionar Personagem
          </button>
        </div>
        
        <div class="characters-grid" id="charactersList">
          <div class="character-card">
            <div class="character-name">Você (GM)</div>
            <div class="character-class">Mestre da Campanha</div>
            <div class="campaign-status status-active">GM</div>
          </div>
        </div>
      </div>

      <!-- SUBABA: NPCs -->
      <div id="subaba-npcs" class="subaba-content">
        <div class="subaba-header">
          <h3><i class="fas fa-robot"></i> NPCs da Campanha</h3>
          <button class="btn btn-primary" onclick="showAddNPCModal()">
            <i class="fas fa-plus"></i>
            Adicionar NPC
          </button>
        </div>
        
        <div class="npcs-list" id="npcsList">
          <!-- NPCs serão adicionados aqui -->
        </div>
      </div>

      <!-- SUBABA: ROLAGENS -->
      <div id="subaba-rolagens" class="subaba-content">
        <div class="subaba-header">
          <h3><i class="fas fa-dice"></i> Histórico de Rolagens</h3>
          <button class="btn btn-primary" onclick="simulateDiceRoll()">
            <i class="fas fa-dice-d20"></i>
            Simular Rolagem
          </button>
        </div>
        
        <div class="dice-history" id="diceHistory">
          <div class="dice-roll">
            <strong>GM</strong> rolou 1d20: <strong>15</strong> (Percepção)
            <small style="color: #94a3b8; display: block;">há 5 minutos</small>
          </div>
        </div>
      </div>

      <!-- SUBABA: CHAT -->
      <div id="subaba-chat" class="subaba-content">
        <div class="subaba-header">
          <h3><i class="fas fa-comments"></i> Chat da Campanha</h3>
          <div style="color: #94a3b8; font-size: 14px;">
            Chat será ativado após criar a campanha
          </div>
        </div>
        
        <div style="background: #0f172a; border-radius: 8px; padding: 20px; text-align: center; margin-top: 20px;">
          <i class="fas fa-comments fa-3x" style="color: #475569; margin-bottom: 15px;"></i>
          <p style="color: #94a3b8;">O chat ficará disponível após a criação da campanha</p>
        </div>
      </div>

      <!-- SUBABA: MAPAS -->
      <div id="subaba-mapas" class="subaba-content">
        <div class="subaba-header">
          <h3><i class="fas fa-map"></i> Mapas da Campanha</h3>
          <button class="btn btn-primary">
            <i class="fas fa-upload"></i>
            Adicionar Mapa
          </button>
        </div>
        
        <div style="background: #0f172a; border-radius: 8px; padding: 30px; text-align: center; margin-top: 20px;">
          <i class="fas fa-map-marked-alt fa-3x" style="color: #475569; margin-bottom: 15px;"></i>
          <p style="color: #94a3b8;">Adicione mapas para sua campanha</p>
        </div>
      </div>

      <!-- SUBABA: TABELAS -->
      <div id="subaba-tabelas" class="subaba-content">
        <div class="subaba-header">
          <h3><i class="fas fa-table"></i> Tabelas da Campanha</h3>
          <button class="btn btn-primary" onclick="showAddTableModal()">
            <i class="fas fa-plus"></i>
            Adicionar Tabela
          </button>
        </div>
        
        <div id="tablesList">
          <!-- Tabelas serão adicionadas aqui -->
        </div>
      </div>

      <!-- NOVA SUBABA: MINHAS CAMPANHAS -->
      <div id="subaba-minhas-campanhas" class="subaba-content">
        <div class="subaba-header">
          <h3><i class="fas fa-bookmark"></i> Minhas Campanhas</h3>
          <div>
            <button class="btn btn-secondary" onclick="refreshMyCampaigns()">
              <i class="fas fa-sync-alt"></i>
              Atualizar
            </button>
            <button class="btn btn-primary" onclick="showSubaba('info')" style="margin-left: 10px;">
              <i class="fas fa-plus"></i>
              Nova Campanha
            </button>
          </div>
        </div>
        
        <div id="myCampaignsList" class="campaigns-grid">
          <!-- Campanhas serão carregadas aqui -->
          <div class="empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            <h4>Carregando suas campanhas...</h4>
            <p>As campanhas que você criar aparecerão aqui</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL ADICIONAR PERSONAGEM -->
  <div id="addCharacterModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-user-plus"></i> Adicionar Personagem</h3>
        <button class="modal-close" onclick="closeModal('addCharacterModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Nome do Personagem *</label>
          <input type="text" id="characterName" class="form-control">
        </div>
        <div class="form-group">
          <label class="form-label">Classe/Arquétipo</label>
          <input type="text" id="characterClass" class="form-control">
        </div>
        <div class="form-group">
          <label class="form-label">Nível</label>
          <input type="number" id="characterLevel" class="form-control" value="1" min="1">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addCharacterModal')">Cancelar</button>
        <button class="btn btn-primary" onclick="addCharacter()">Adicionar</button>
      </div>
    </div>
  </div>

  <!-- MODAL ADICIONAR NPC -->
  <div id="addNPCModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-robot"></i> Adicionar NPC</h3>
        <button class="modal-close" onclick="closeModal('addNPCModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Nome do NPC *</label>
          <input type="text" id="npcName" class="form-control">
        </div>
        <div class="form-group">
          <label class="form-label">Função/Role</label>
          <input type="text" id="npcRole" class="form-control" placeholder="Ex: Mercador, Guarda, etc">
        </div>
        <div class="form-group">
          <label class="form-label">Descrição</label>
          <textarea id="npcDescription" class="form-control" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addNPCModal')">Cancelar</button>
        <button class="btn btn-primary" onclick="addNPC()">Adicionar</button>
      </div>
    </div>
  </div>

  <!-- MODAL ADICIONAR TABELA -->
  <div id="addTableModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3><i class="fas fa-table"></i> Adicionar Tabela</h3>
        <button class="modal-close" onclick="closeModal('addTableModal')">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Nome da Tabela *</label>
          <input type="text" id="tableName" class="form-control">
        </div>
        <div class="form-group">
          <label class="form-label">Tipo</label>
          <select id="tableType" class="form-control">
            <option value="treasure">Tesouro</option>
            <option value="encounter">Encontro</option>
            <option value="loot">Saque</option>
            <option value="random">Aleatória</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Descrição</label>
          <textarea id="tableDescription" class="form-control" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('addTableModal')">Cancelar</button>
        <button class="btn btn-primary" onclick="addTable()">Adicionar</button>
      </div>
    </div>
  </div>

  <script>
  // Configuração do Supabase
  const SUPABASE_URL = 'https://pujufdfhaxveuytkneqw.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1anVmZGZoYXh2ZXV5dGtuZXF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNTkyODksImV4cCI6MjA3OTkzNTI4OX0.mzOwsmf8qIQ4HZqnXLEmq4D7M6fz4VH1YWpWP-BsFvc';

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Estado global
  let currentUser = null;
  let userGuilds = [];
  let myCampaigns = [];

  // Inicialização
  document.addEventListener('DOMContentLoaded', async () => {
    console.log('Iniciando campanhas...');
    await init();
  });

  // Inicialização
  async function init() {
    try {
      // 1. Verificar autenticação
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        window.location.href = 'login.html';
        return;
      }
      
      // 2. Carregar dados do usuário
      const { data: profile } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', session.user.id)
        .single();
      
      if (profile) {
        currentUser = {
          id: session.user.id,
          username: profile.username || 'Usuário',
          playerId: profile.player_id || '000000'
        };
        
        document.getElementById('playerId').textContent = '#' + currentUser.playerId;
        document.getElementById('userAvatar').textContent = currentUser.username.charAt(0).toUpperCase();
      }
      
      // 3. Carregar guildas
      await loadGuilds();
      
      // 4. Gerar ID da campanha
      generateCampaignId();
      
      // 5. Configurar eventos
      setupEvents();
      
      console.log('Sistema de campanhas pronto!');
      
    } catch (error) {
      console.error('Erro na inicialização:', error);
      alert('Erro ao carregar sistema de campanhas: ' + error.message);
    }
  }

  // Carregar guildas do usuário
  async function loadGuilds() {
    try {
      console.log('Carregando guildas do usuário...');
      
      // Primeiro, verificar se o usuário tem guildas
      const { data: memberships, error } = await supabase
        .from('guild_members')
        .select('guild_id, role')
        .eq('user_id', currentUser.id)
        .eq('status', 'accepted');
      
      if (error) {
        console.error('Erro ao buscar guildas:', error);
        showNoGuilds();
        return;
      }
      
      if (!memberships || memberships.length === 0) {
        console.log('Usuário não tem guildas');
        showNoGuilds();
        return;
      }
      
      // Buscar detalhes das guildas
      userGuilds = [];
      for (const membership of memberships) {
        const { data: guild } = await supabase
          .from('guilds')
          .select('id, name, custom_id')
          .eq('id', membership.guild_id)
          .single();
        
        if (guild) {
          userGuilds.push({
            id: guild.id,
            name: guild.name,
            custom_id: guild.custom_id,
            role: membership.role,
            is_owner: membership.role === 'owner'
          });
        }
      }
      
      if (userGuilds.length === 0) {
        showNoGuilds();
        return;
      }
      
      updateGuildsUI();
      
    } catch (error) {
      console.error('Erro ao carregar guildas:', error);
      showNoGuilds();
    }
  }

  // Atualizar interface das guildas
  function updateGuildsUI() {
    const guildSelect = document.getElementById('campaignGuild');
    const createBtn = document.getElementById('createCampaignBtn');
    const guildInfo = document.getElementById('currentGuildName');
    
    // Limpar select
    guildSelect.innerHTML = '<option value="">Selecione uma Guilda</option>';
    
    // Adicionar opções
    userGuilds.forEach(guild => {
      const option = document.createElement('option');
      option.value = guild.id;
      option.textContent = `${guild.name} (${guild.is_owner ? 'Dono' : 'Membro'})`;
      guildSelect.appendChild(option);
    });
    
    // Atualizar info da guilda
    if (userGuilds.length > 0) {
      const firstGuild = userGuilds[0];
      guildInfo.textContent = `${firstGuild.name} (${firstGuild.is_owner ? 'Dono' : 'Membro'})`;
      
      // Selecionar primeira guilda automaticamente
      if (userGuilds.length === 1) {
        guildSelect.value = firstGuild.id;
      }
    }
    
    // Habilitar botão de criação
    createBtn.disabled = false;
    createBtn.style.opacity = '1';
    createBtn.innerHTML = '<i class="fas fa-save"></i> Criar Campanha';
    
    console.log(`${userGuilds.length} guilda(s) carregada(s)`);
  }

  // Mostrar mensagem de sem guildas
  function showNoGuilds() {
    const guildInfo = document.getElementById('guildInfo');
    const createBtn = document.getElementById('createCampaignBtn');
    
    guildInfo.innerHTML = `
      <i class="fas fa-exclamation-triangle"></i>
      <div>
        <strong>Atenção:</strong> Você precisa estar em uma Guilda para criar campanhas.
        <a href="guilda.html" style="color: #f59e0b; margin-left: 10px;">Ir para Guildas</a>
      </div>
    `;
    
    createBtn.disabled = true;
    createBtn.style.opacity = '0.5';
    createBtn.innerHTML = '<i class="fas fa-ban"></i> Necessita Guilda';
    
    console.log('Usuário não tem guildas - criação de campanha desabilitada');
  }

  // ============================================
  // FUNÇÕES DA NOVA ABA: MINHAS CAMPANHAS
  // ============================================

  // Carregar campanhas do usuário
  async function loadMyCampaigns() {
    const campaignsList = document.getElementById('myCampaignsList');
    
    try {
      // Mostrar loading
      campaignsList.innerHTML = `
        <div style="text-align: center; padding: 40px;">
          <div class="loading-spinner" style="width: 30px; height: 30px; margin: 0 auto 20px;"></div>
          <p style="color: #94a3b8;">Carregando suas campanhas...</p>
        </div>
      `;
      
      console.log('Buscando campanhas do usuário...');
      
      // Buscar campanhas onde o usuário é GM
      const { data: campaigns, error } = await supabase
        .from('campaigns')
        .select('*')
        .eq('gm_id', currentUser.id)
        .order('created_at', { ascending: false });
      
      if (error) {
        console.error('Erro ao carregar campanhas:', error);
        
        // Tentar usar RPC se a tabela direto falhar
        try {
          const { data: rpcData } = await supabase.rpc('minhas_campanhas_gm');
          if (rpcData) {
            myCampaigns = rpcData;
            displayMyCampaigns();
            return;
          }
        } catch (rpcError) {
          console.log('RPC também falhou:', rpcError);
        }
        
        showEmptyCampaigns('Erro ao carregar campanhas');
        return;
      }
      
      myCampaigns = campaigns || [];
      console.log(`Encontradas ${myCampaigns.length} campanha(s)`);
      
      if (myCampaigns.length === 0) {
        showEmptyCampaigns();
        return;
      }
      
      displayMyCampaigns();
      
    } catch (error) {
      console.error('Erro inesperado ao carregar campanhas:', error);
      showEmptyCampaigns('Erro inesperado');
    }
  }

  // Mostrar estado vazio
  function showEmptyCampaigns(message = null) {
    const campaignsList = document.getElementById('myCampaignsList');
    
    campaignsList.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-book-open"></i>
        <h4>Nenhuma campanha encontrada</h4>
        <p>${message || 'Crie sua primeira campanha usando o formulário na aba "Informações"'}</p>
        <button class="btn btn-primary" onclick="showSubaba('info')">
          <i class="fas fa-plus"></i>
          Criar Primeira Campanha
        </button>
      </div>
    `;
  }

  // Exibir campanhas na lista
  function displayMyCampaigns() {
    const campaignsList = document.getElementById('myCampaignsList');
    
    campaignsList.innerHTML = '';
    
    myCampaigns.forEach(campaign => {
      const card = document.createElement('div');
      card.className = 'campaign-card';
      card.onclick = () => viewCampaignDetails(campaign.campaign_id);
      
      // Formatar data
      const createdAt = new Date(campaign.created_at);
      const formattedDate = createdAt.toLocaleDateString('pt-BR');
      
      // Mapear status para cores
      const statusConfig = {
        'active': { text: 'Ativa', class: 'status-active', icon: 'fa-play' },
        'paused': { text: 'Pausada', class: 'status-paused', icon: 'fa-pause' },
        'finished': { text: 'Finalizada', class: 'status-finished', icon: 'fa-flag-checkered' }
      };
      
      const status = statusConfig[campaign.status] || statusConfig.active;
      
      card.innerHTML = `
        <div class="campaign-card-header">
          <div>
            <div class="campaign-name">${campaign.name || 'Sem nome'}</div>
            <div class="campaign-id">ID: ${campaign.campaign_id || 'N/A'}</div>
          </div>
          <div class="campaign-status ${status.class}">
            <i class="fas ${status.icon}"></i>
            ${status.text}
          </div>
        </div>
        
        <div class="campaign-description">
          ${campaign.description || 'Sem descrição disponível.'}
        </div>
        
        <div class="campaign-footer">
          <div class="campaign-meta">
            <div class="campaign-meta-item">
              <i class="fas fa-calendar"></i>
              ${formattedDate}
            </div>
            ${campaign.chapter ? `
              <div class="campaign-meta-item">
                <i class="fas fa-flag"></i>
                ${campaign.chapter}
              </div>
            ` : ''}
            ${campaign.scenario ? `
              <div class="campaign-meta-item">
                <i class="fas fa-globe"></i>
                ${campaign.scenario}
              </div>
            ` : ''}
          </div>
          <button class="btn btn-small btn-secondary" onclick="viewCampaignDetails('${campaign.campaign_id}'); event.stopPropagation();">
            <i class="fas fa-external-link-alt"></i>
            Abrir
          </button>
        </div>
      `;
      
      campaignsList.appendChild(card);
    });
  }

  // Ver detalhes da campanha
  function viewCampaignDetails(campaignId) {
    if (!campaignId) {
      alert('ID da campanha não encontrado');
      return;
    }
    console.log(`Abrindo campanha: ${campaignId}`);
    window.location.href = `campanha-detalhes.html?id=${campaignId}`;
  }

  // Atualizar lista de campanhas
  function refreshMyCampaigns() {
    console.log('Atualizando lista de campanhas...');
    loadMyCampaigns();
  }

  // ============================================
  // FUNÇÕES PRINCIPAIS
  // ============================================

  // Gerar ID da campanha
  function generateCampaignId() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = 'CAMP';
    for (let i = 0; i < 6; i++) {
      result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    document.getElementById('campaignId').value = result;
    console.log(`ID gerado: ${result}`);
    return result;
  }

  // Mudar subaba
  function showSubaba(subaba) {
    // Esconder todas
    document.querySelectorAll('.subaba-content').forEach(el => {
      el.classList.remove('active');
    });
    document.querySelectorAll('.subaba-tab-top').forEach(tab => {
      tab.classList.remove('active');
    });
    
    // Mostrar selecionada
    document.getElementById(`subaba-${subaba}`).classList.add('active');
    const tab = document.querySelector(`.subaba-tab-top[onclick*="${subaba}"]`);
    if (tab) tab.classList.add('active');
    
    // Se for a aba "Minhas Campanhas", carregar campanhas
    if (subaba === 'minhas-campanhas') {
      console.log('Abrindo aba Minhas Campanhas');
      loadMyCampaigns();
    }
  }

  // Mostrar modal
  function showModal(modalId) {
    document.getElementById(modalId).style.display = 'flex';
  }

  // Fechar modal
  function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
  }

  // Configurar eventos
  function setupEvents() {
    // Botão criar campanha
    document.getElementById('createCampaignBtn').addEventListener('click', createCampaign);
    
    // Botão gerar ID
    document.querySelector('.generate-id-btn').addEventListener('click', generateCampaignId);
    
    // Fechar modais ao clicar fora
    window.addEventListener('click', (event) => {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    });
    
    // Auto-gera ID ao carregar
    document.getElementById('campaignId').addEventListener('focus', function() {
      if (!this.value) generateCampaignId();
    });
  }

  // FUNÇÃO PRINCIPAL: CRIAR CAMPANHA
  async function createCampaign() {
    console.log('Iniciando criação de campanha...');
    
    try {
      // 1. Coletar dados
      const campaignId = document.getElementById('campaignId').value.trim();
      const campaignName = document.getElementById('campaignName').value.trim();
      const guildId = document.getElementById('campaignGuild').value;
      const status = document.getElementById('campaignStatus').value;
      const scenario = document.getElementById('campaignScenario').value.trim();
      const chapter = document.getElementById('campaignChapter').value.trim();
      const description = document.getElementById('campaignDescription').value.trim();
      
      // 2. Validações básicas
      if (!campaignName) {
        alert('Digite o nome da campanha!');
        document.getElementById('campaignName').focus();
        return;
      }
      
      if (!campaignId) {
        alert('Gere um ID para a campanha!');
        generateCampaignId();
        return;
      }
      
      if (!guildId) {
        alert('Selecione uma Guilda!');
        document.getElementById('campaignGuild').focus();
        return;
      }
      
      // 3. Verificar se o usuário pertence à guilda selecionada
      const selectedGuild = userGuilds.find(g => g.id === guildId);
      if (!selectedGuild) {
        alert('Você não pertence a esta Guilda!');
        return;
      }
      
      // 4. Confirmação
      if (!confirm(`Criar campanha "${campaignName}"?\n\nID: ${campaignId}\nGuilda: ${selectedGuild.name}`)) {
        console.log('Criação cancelada pelo usuário');
        return;
      }
      
      // 5. Preparar botão
      const createBtn = document.getElementById('createCampaignBtn');
      const originalText = createBtn.innerHTML;
      createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando...';
      createBtn.disabled = true;
      
      console.log('Dados da campanha:', {
        campaignId,
        campaignName,
        guildId,
        status,
        scenario,
        chapter,
        description
      });
      
      // 6. Verificar se ID já existe
      const { data: existing } = await supabase
        .from('campaigns')
        .select('campaign_id')
        .eq('campaign_id', campaignId)
        .single();
      
      if (existing) {
        alert('Este ID já está em uso! Gere um novo.');
        generateCampaignId();
        createBtn.innerHTML = originalText;
        createBtn.disabled = false;
        return;
      }
      
      // 7. Criar campanha (usar RPC se disponível, senão INSERT direto)
      let campaignData;
      let error;
      
      try {
        // Tentar RPC primeiro
        const { data: rpcData, error: rpcError } = await supabase.rpc('criar_campanha_simples', {
          p_campaign_id: campaignId,
          p_name: campaignName,
          p_guild_id: guildId,
          p_description: description || null,
          p_scenario: scenario || null
        });
        
        if (rpcError) throw rpcError;
        
        if (rpcData && rpcData.success) {
          console.log('Campanha criada via RPC:', rpcData);
          campaignData = rpcData;
        } else {
          throw new Error(rpcData?.error || 'Erro na função RPC');
        }
        
      } catch (rpcException) {
        console.log('RPC falhou, tentando INSERT direto:', rpcException);
        
        // Fallback: INSERT direto
        const { data: insertData, error: insertError } = await supabase
          .from('campaigns')
          .insert([{
            campaign_id: campaignId,
            name: campaignName,
            description: description || null,
            scenario: scenario || null,
            chapter: chapter || null,
            status: status,
            guild_id: guildId,
            gm_id: currentUser.id
          }])
          .select()
          .single();
        
        if (insertError) throw insertError;
        
        // Adicionar GM como participante
        await supabase
          .from('campaign_participants')
          .insert([{
            campaign_id: campaignId,
            user_id: currentUser.id,
            role: 'gm',
            participant_status: 'active'
          }]);
        
        campaignData = {
          success: true,
          campaign_id: campaignId,
          message: 'Campanha criada com sucesso!'
        };
      }
      
      // 8. Sucesso - Atualizar lista de campanhas
      if (campaignData.success) {
        // Adicionar à lista local
        myCampaigns.unshift({
          campaign_id: campaignId,
          name: campaignName,
          description: description || null,
          scenario: scenario || null,
          chapter: chapter || null,
          status: status,
          created_at: new Date().toISOString()
        });
        
        // 9. Feedback e limpeza
        alert(`✅ ${campaignData.message}\n\nID: ${campaignId}\nNome: ${campaignName}`);
        
        // Gerar novo ID para próxima campanha
        generateCampaignId();
        
        // Limpar formulário parcialmente (mantém guilda)
        document.getElementById('campaignName').value = '';
        document.getElementById('campaignDescription').value = '';
        document.getElementById('campaignScenario').value = '';
        document.getElementById('campaignChapter').value = '';
        
        // Mostrar na aba "Minhas Campanhas"
        showSubaba('minhas-campanhas');
        
        console.log(`Campanha criada com sucesso: ${campaignId}`);
      } else {
        alert('Erro: ' + (campaignData.error || 'Erro desconhecido'));
      }
      
    } catch (error) {
      console.error('Erro ao criar campanha:', error);
      alert('Erro ao criar campanha: ' + (error.message || 'Erro desconhecido'));
      
    } finally {
      // Restaurar botão
      const createBtn = document.getElementById('createCampaignBtn');
      createBtn.innerHTML = '<i class="fas fa-save"></i> Criar Campanha';
      createBtn.disabled = false;
    }
  }

  // ============================================
  // FUNÇÕES AUXILIARES E MODAIS
  // ============================================

  // Exportar funções para HTML
  window.showSubaba = showSubaba;
  window.showAddCharacterModal = () => showModal('addCharacterModal');
  window.showAddNPCModal = () => showModal('addNPCModal');
  window.showAddTableModal = () => showModal('addTableModal');
  window.closeModal = closeModal;
  window.generateCampaignId = generateCampaignId;
  window.createCampaign = createCampaign;
  window.refreshMyCampaigns = refreshMyCampaigns;
  window.viewCampaignDetails = viewCampaignDetails;

  // Funções básicas para modais
  window.addCharacter = function() {
    const name = document.getElementById('characterName').value;
    if (!name) {
      alert('Digite o nome do personagem!');
      return;
    }
    alert('Personagem adicionado: ' + name);
    closeModal('addCharacterModal');
  };

  window.addNPC = function() {
    const name = document.getElementById('npcName').value;
    if (!name) {
      alert('Digite o nome do NPC!');
      return;
    }
    alert('NPC adicionado: ' + name);
    closeModal('addNPCModal');
  };

  window.addTable = function() {
    const name = document.getElementById('tableName').value;
    if (!name) {
      alert('Digite o nome da tabela!');
      return;
    }
    alert('Tabela adicionada: ' + name);
    closeModal('addTableModal');
  };

  // Simular rolagem de dados
  window.simulateDiceRoll = function() {
    const roll = Math.floor(Math.random() * 20) + 1;
    const history = document.getElementById('diceHistory');
    const rollElement = document.createElement('div');
    rollElement.className = 'dice-roll';
    rollElement.innerHTML = `
      <strong>GM</strong> rolou 1d20: <strong>${roll}</strong> (Teste)
      <small style="color: #94a3b8; display: block;">${new Date().toLocaleTimeString('pt-BR')}</small>
    `;
    history.insertBefore(rollElement, history.firstChild);
  };

  console.log('Sistema de campanhas carregado com sucesso!');
  </script>
</body>
</html>