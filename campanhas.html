<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Campanhas - RPG System GURPS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;-webkit-tap-highlight-color:transparent}html{font-size:16px}body{background:linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8)),url('Cris2.jpg') no-repeat center center fixed;background-size:cover;color:#fff;min-height:100vh;display:flex;flex-direction:column}.header{background:rgba(30,30,40,0.95);padding:12px 15px;border-bottom:2px solid rgba(255,140,0,0.4);position:sticky;top:0;z-index:100}.header-content{max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;gap:10px}.logo h1{font-size:1.5rem;background:linear-gradient(45deg,#ffd700,#ff8c00);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}.logo p{font-size:0.8rem;color:#ccc}.user-menu{display:flex;align-items:center;gap:8px}.header-btn{padding:8px 12px;border-radius:6px;border:none;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:5px;font-size:0.85rem}.back-btn{background:rgba(52,152,219,0.8);color:white}.logout-btn{background:rgba(231,76,60,0.8);color:white}.user-avatar{width:35px;height:35px;border-radius:50%;background:linear-gradient(45deg,#ff8c00,#ff4500);display:flex;align-items:center;justify-content:center;font-weight:bold;color:white}.main-content{max-width:1200px;margin:20px auto;padding:0 15px;flex:1;width:100%}.main-tabs{display:flex;background:rgba(30,30,40,0.8);border-radius:10px;margin-bottom:20px;border:1px solid rgba(255,140,0,0.2)}.main-tab{flex:1;padding:16px 10px;text-align:center;background:none;border:none;color:#ccc;font-weight:600;cursor:pointer;border-right:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;gap:8px}.main-tab.active{background:rgba(255,140,0,0.2);color:#ffd700;border-bottom:3px solid #ff8c00}.sub-tabs{display:flex;background:rgba(40,40,50,0.7);border-radius:8px;margin-bottom:20px;border:1px solid rgba(255,140,0,0.15);overflow-x:auto}.sub-tab{padding:12px 16px;background:none;border:none;color:#aaa;font-weight:500;cursor:pointer;border-right:1px solid rgba(255,255,255,0.05);white-space:nowrap;display:flex;align-items:center;gap:6px}.sub-tab.active{background:rgba(255,140,0,0.15);color:#ffd700;border-bottom:2px solid #ff8c00}.tab-content{display:none;background:rgba(30,30,40,0.7);border-radius:12px;padding:25px;border:1px solid rgba(255,140,0,0.2);margin-bottom:25px}.tab-content.active{display:block}.content-header{margin-bottom:25px;text-align:center}.content-header h2{color:#ffd700;font-size:1.8rem;margin-bottom:8px}.content-header p{color:#aaa;font-size:0.95rem;max-width:600px;margin:0 auto}.form-container{max-width:600px;margin:0 auto;background:rgba(40,40,50,0.5);border-radius:10px;padding:25px;border:1px solid rgba(255,255,255,0.1)}.form-group{margin-bottom:20px}.form-label{display:block;margin-bottom:8px;color:#ccc;font-weight:500}.form-input{width:100%;padding:12px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,140,0,0.3);border-radius:6px;color:white;font-size:0.95rem}.form-textarea{width:100%;padding:12px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,140,0,0.3);border-radius:6px;color:white;min-height:100px;resize:vertical}.form-note{color:#888;font-size:0.8rem;margin-top:5px;display:block}.btn{padding:12px 20px;background:linear-gradient(45deg,#ff8c00,#ff4500);border:none;border-radius:8px;color:white;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-size:0.9rem}.btn-full{width:100%;justify-content:center;padding:14px;font-size:1rem}.generate-btn{padding:12px 18px;background:rgba(52,152,219,0.8);border:none;border-radius:6px;color:white;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:6px;font-size:0.9rem}.message{padding:12px 15px;border-radius:8px;margin-bottom:15px;font-size:0.9rem;display:none}.message.success{background:rgba(46,204,113,0.2);border:1px solid rgba(46,204,113,0.3);color:#2ecc71;display:block}.message.error{background:rgba(231,76,60,0.2);border:1px solid rgba(231,76,60,0.3);color:#e74c3c;display:block}.campaigns-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px}.campaign-card{background:rgba(40,40,50,0.7);border-radius:10px;padding:20px;border:1px solid rgba(255,140,0,0.3);transition:transform .2s}.campaign-card:hover{transform:translateY(-2px);border-color:rgba(255,140,0,0.5)}.campaign-card h3{color:#ffd700;margin-bottom:10px;font-size:1.2rem}.campaign-code{background:rgba(255,140,0,0.2);color:#ffd700;padding:4px 8px;border-radius:4px;font-family:monospace;font-size:0.9rem;display:inline-block;margin-bottom:10px}.campaign-meta{display:flex;justify-content:space-between;margin-top:15px;padding-top:15px;border-top:1px solid rgba(255,255,255,0.1)}.campaign-stat{display:flex;flex-direction:column;align-items:center}.campaign-stat i{color:#ff8c00;margin-bottom:5px}.campaign-stat span{font-size:0.8rem;color:#aaa}.empty-state{text-align:center;padding:60px 20px;color:#888}.empty-state i{font-size:3rem;margin-bottom:20px;color:rgba(255,140,0,0.3)}.footer{background:rgba(20,20,30,0.9);padding:12px 0;text-align:center;margin-top:auto;border-top:1px solid rgba(255,140,0,0.2)}.footer p{color:#888;font-size:0.8rem}@media (max-width:768px){.header-content{flex-direction:row}.logo h1{font-size:1.3rem}.main-tabs{flex-direction:row}.main-tab{padding:12px 8px;font-size:0.9rem}.sub-tabs{flex-wrap:nowrap}.sub-tab{padding:10px 12px;font-size:0.85rem}.tab-content{padding:20px}.campaigns-grid{grid-template-columns:1fr}}@media (max-width:480px){.header{padding:10px}.logo h1{font-size:1.2rem}.user-menu{gap:5px}.header-btn{padding:6px 8px;font-size:0.8rem}.user-avatar{width:32px;height:32px;font-size:0.8rem}.main-tab{padding:10px 6px;font-size:0.85rem}.sub-tab{padding:8px 10px;font-size:0.8rem}.tab-content{padding:15px}.content-header h2{font-size:1.3rem}}
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <h1>RPG SYSTEM GURPS</h1>
                <p>Campanhas</p>
            </div>
            <div class="user-menu">
                <button class="header-btn back-btn" id="backBtn">
                    <i class="fas fa-arrow-left"></i>
                    <span class="text">Voltar</span>
                </button>
                <button class="header-btn logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="text">Sair</span>
                </button>
                <div class="user-avatar" id="userAvatar">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="main-tabs">
            <button class="main-tab" data-main-tab="player">
                <i class="fas fa-user"></i> <span>JOGADOR</span>
            </button>
            <button class="main-tab active" data-main-tab="gm">
                <i class="fas fa-crown"></i> <span>MESTRE</span>
            </button>
        </div>

        <div class="sub-tabs player-subtabs" id="player-subtabs" style="display: none;">
            <button class="sub-tab" data-sub-tab="player-campaigns" data-main-tab="player">
                <i class="fas fa-book"></i> <span>Minhas Campanhas</span>
            </button>
            <button class="sub-tab" data-sub-tab="player-sheets" data-main-tab="player">
                <i class="fas fa-scroll"></i> <span>Fichas</span>
            </button>
        </div>

        <div class="sub-tabs gm-subtabs" id="gm-subtabs">
            <button class="sub-tab" data-sub-tab="gm-campaigns" data-main-tab="gm">
                <i class="fas fa-book"></i> <span>Minhas Campanhas</span>
            </button>
            <button class="sub-tab active" data-sub-tab="gm-create" data-main-tab="gm">
                <i class="fas fa-plus-circle"></i> <span>Criar Campanha</span>
            </button>
        </div>

        <div class="tab-content" id="player-campaigns-content" hidden>
            <div class="content-header">
                <h2>Minhas Campanhas como Jogador</h2>
                <p>Campanhas GURPS onde voc√™ est√° participando como jogador.</p>
            </div>
            <div id="player-campaigns-list">
                <p style="color: #888; text-align: center; padding: 40px;">Carregando campanhas...</p>
            </div>
        </div>

        <div class="tab-content" id="player-sheets-content" hidden>
            <div class="content-header">
                <h2>Fichas de Personagem GURPS</h2>
                <p>Gerencie suas fichas de personagem para campanhas GURPS.</p>
            </div>
            <div style="text-align: center; padding: 40px;">
                <p style="color: #888;">Em desenvolvimento</p>
            </div>
        </div>

        <div class="tab-content" id="gm-campaigns-content" hidden>
            <div class="content-header">
                <h2>Minhas Campanhas como Mestre</h2>
                <p>Campanhas GURPS onde voc√™ √© o mestre.</p>
            </div>
            <div id="gm-campaigns-list">
                <p style="color: #888; text-align: center; padding: 40px;">Carregando campanhas...</p>
            </div>
        </div>

        <div class="tab-content active" id="gm-create-content">
            <div class="content-header">
                <h2>Criar Nova Campanha GURPS</h2>
                <p>Crie uma nova campanha para o sistema GURPS.</p>
            </div>
            
            <div class="form-container">
                <form id="createCampaignForm">
                    <div class="form-group">
                        <label class="form-label" for="campaignName">Nome da Campanha *</label>
                        <input type="text" class="form-input" id="campaignName" required 
                               placeholder="Ex: Aventuras em Ciudad Ju√°rez" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="campaignId">C√≥digo da Campanha (7 d√≠gitos) *</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" class="form-input" id="campaignId" required 
                                   placeholder="Ex: 1234567" pattern="[0-9]{7}" 
                                   minlength="7" maxlength="7"
                                   style="flex: 1;">
                            <button type="button" class="generate-btn" id="generateCodeBtn">
                                <i class="fas fa-redo"></i> Gerar
                            </button>
                        </div>
                        <span class="form-note">7 d√≠gitos num√©ricos √∫nicos</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="campaignDescription">Descri√ß√£o</label>
                        <textarea class="form-textarea" id="campaignDescription" 
                                  placeholder="Descreva sua campanha GURPS..."
                                  maxlength="500"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="campaignSetting">Cen√°rio/Mundo</label>
                        <input type="text" class="form-input" id="campaignSetting" 
                               placeholder="Ex: Ciudad Ju√°rez, Mundo Moderno" maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="startingPoints">Pontos Iniciais</label>
                        <input type="number" class="form-input" id="startingPoints" 
                               value="100" min="25" max="1000">
                        <span class="form-note">Pontos GURPS para cria√ß√£o de personagem</span>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="maxPlayers">Limite de Jogadores</label>
                        <input type="number" class="form-input" id="maxPlayers" 
                               value="6" min="1" max="10">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="campaignStatus">Status</label>
                        <select class="form-input" id="campaignStatus">
                            <option value="preparation">Prepara√ß√£o</option>
                            <option value="active">Ativa</option>
                            <option value="paused">Pausada</option>
                        </select>
                    </div>
                    
                    <div id="createCampaignMessage"></div>
                    
                    <button type="submit" class="btn btn-full" id="submitCreateCampaign">
                        <i class="fas fa-plus-circle"></i> Criar Campanha GURPS
                    </button>
                </form>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>RPG System GURPS &copy; 2024</p>
    </footer>

    <script>
        const SUPABASE_URL = 'https://pujufdfhaxveuytkneqw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1anVmZGZoYXh2ZXV5dGtuZXF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNTkyODksImV4cCI6MjA3OTkzNTI4OX0.mzOwsmf8qIQ4HZqnXLEmq4D7M6fz4VH1YWpWP-BsFvc';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;
        let userGuild = null;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('üöÄ Iniciando sistema de campanhas...');
                await checkAuth();
                await loadUserData();
                await loadUserGuild();
                setupEventListeners();
                setupTabs();
                generateCampaignId();
                console.log('‚úÖ Sistema iniciado! Guilda:', userGuild);
            } catch (error) {
                console.error('‚ùå Erro:', error);
                showMessage('Erro ao carregar. Recarregue a p√°gina.', 'error');
            }
        });

        async function checkAuth() {
            const { data: { session }, error } = await supabase.auth.getSession();
            if (error) throw error;
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = session.user;
            console.log('üë§ Usu√°rio:', currentUser.id, currentUser.email);
        }

        async function loadUserData() {
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();
            if (profile) {
                const initials = profile.username?.charAt(0).toUpperCase() || 'U';
                document.getElementById('userAvatar').innerHTML = initials;
            }
        }

        async function loadUserGuild() {
            try {
                console.log('üîç Buscando guilda do usu√°rio...');
                
                // 1. Primeiro verifica se √© DONO de uma guilda
                const { data: ownedGuild, error: ownedError } = await supabase
                    .from('guilds')
                    .select('*')
                    .eq('owner_id', currentUser.id)
                    .single();
                
                if (!ownedError && ownedGuild) {
                    userGuild = ownedGuild;
                    console.log('üëë Usu√°rio √© DONO da guilda:', ownedGuild.name);
                    showMessage(`‚úÖ Guilda encontrada: ${ownedGuild.name}`, 'success', 'gm-create-content');
                    return;
                }
                
                console.log('Usu√°rio n√£o √© dono de guilda. Buscando como membro...');
                
                // 2. Se n√£o for dono, verifica se √© MEMBRO
                const { data: memberships, error: memberError } = await supabase
                    .from('guild_members')
                    .select(`
                        *,
                        guilds(*)
                    `)
                    .eq('user_id', currentUser.id)
                    .eq('status', 'accepted')
                    .limit(1);
                
                if (memberError) {
                    console.error('Erro ao buscar membros:', memberError);
                    return;
                }
                
                if (memberships && memberships.length > 0) {
                    userGuild = memberships[0].guilds;
                    console.log('üë• Usu√°rio √© MEMBRO da guilda:', userGuild.name);
                    showMessage(`‚úÖ Guilda encontrada: ${userGuild.name}`, 'success', 'gm-create-content');
                } else {
                    console.log('‚ö†Ô∏è Usu√°rio n√£o est√° em nenhuma guilda');
                    showMessage('‚ö†Ô∏è Voc√™ precisa estar em uma guilda para criar campanhas. Volte para a p√°gina da guilda primeiro.', 'error', 'gm-create-content');
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar guilda:', error);
            }
        }

        function setupTabs() {
            document.querySelectorAll('.main-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabType = tab.getAttribute('data-main-tab');
                    document.querySelectorAll('.main-tab').forEach(t => {
                        t.classList.toggle('active', t === tab);
                    });
                    const playerSubtabs = document.getElementById('player-subtabs');
                    const gmSubtabs = document.getElementById('gm-subtabs');
                    if (tabType === 'player') {
                        playerSubtabs.style.display = 'flex';
                        gmSubtabs.style.display = 'none';
                        activateFirstSubtab('player');
                    } else {
                        playerSubtabs.style.display = 'none';
                        gmSubtabs.style.display = 'flex';
                        activateFirstSubtab('gm');
                    }
                    updateTabContent();
                });
            });
            
            document.querySelectorAll('.sub-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const mainTab = tab.getAttribute('data-main-tab');
                    document.querySelectorAll(`.sub-tab[data-main-tab="${mainTab}"]`).forEach(t => {
                        t.classList.toggle('active', t === tab);
                    });
                    updateTabContent();
                });
            });
        }

        function activateFirstSubtab(mainTab) {
            const firstTab = document.querySelector(`.sub-tab[data-main-tab="${mainTab}"]`);
            if (firstTab) {
                firstTab.classList.add('active');
                document.querySelectorAll(`.sub-tab[data-main-tab="${mainTab}"]`).forEach(tab => {
                    if (tab !== firstTab) tab.classList.remove('active');
                });
            }
        }

        function updateTabContent() {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.hidden = true;
            });
            const activeMainTab = document.querySelector('.main-tab.active');
            const activeSubTab = document.querySelector('.sub-tab.active');
            if (activeMainTab && activeSubTab) {
                const subTabId = activeSubTab.getAttribute('data-sub-tab');
                const contentId = `${subTabId}-content`;
                const contentElement = document.getElementById(contentId);
                if (contentElement) {
                    contentElement.classList.add('active');
                    contentElement.hidden = false;
                }
                if (subTabId === 'player-campaigns') {
                    loadPlayerCampaigns();
                } else if (subTabId === 'gm-campaigns') {
                    loadGMCampaigns();
                } else if (subTabId === 'gm-create') {
                    generateCampaignId();
                }
            }
        }

        function setupEventListeners() {
            document.getElementById('backBtn').addEventListener('click', () => {
                window.location.href = 'guilda.html';
            });
            document.getElementById('logoutBtn').addEventListener('click', async () => {
                if (!confirm('Deseja realmente sair?')) return;
                await supabase.auth.signOut();
                window.location.href = 'login.html';
            });
            document.getElementById('generateCodeBtn').addEventListener('click', generateCampaignId);
            document.getElementById('createCampaignForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createCampaign();
            });
        }

        function generateCampaignId() {
            const idInput = document.getElementById('campaignId');
            let newId;
            do {
                newId = Math.floor(1000000 + Math.random() * 9000000);
            } while (newId > 9999999);
            idInput.value = newId;
        }

        async function createCampaign() {
            console.log('üéØ Iniciando cria√ß√£o de campanha...');
            console.log('Guilda atual:', userGuild);
            
            if (!userGuild) {
                showMessage('‚ùå Voc√™ precisa estar em uma guilda para criar campanhas.', 'error', 'gm-create-content');
                return;
            }
            
            const name = document.getElementById('campaignName').value.trim();
            const campaignId = parseInt(document.getElementById('campaignId').value);
            const description = document.getElementById('campaignDescription').value.trim();
            const setting = document.getElementById('campaignSetting').value.trim();
            const startingPoints = parseInt(document.getElementById('startingPoints').value) || 100;
            const maxPlayers = parseInt(document.getElementById('maxPlayers').value) || 6;
            const status = document.getElementById('campaignStatus').value;
            const submitBtn = document.getElementById('submitCreateCampaign');
            
            if (!name) {
                showMessage('‚ùå O nome da campanha √© obrigat√≥rio.', 'error', 'gm-create-content');
                return;
            }
            
            if (!campaignId || isNaN(campaignId)) {
                showMessage('‚ùå O c√≥digo da campanha √© obrigat√≥rio e deve ser num√©rico.', 'error', 'gm-create-content');
                return;
            }
            
            if (campaignId < 1000000 || campaignId > 9999999) {
                showMessage('‚ùå O c√≥digo deve ter exatamente 7 d√≠gitos (entre 1000000 e 9999999).', 'error', 'gm-create-content');
                return;
            }
            
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Criando...';
            submitBtn.disabled = true;
            
            try {
                console.log('üì¶ Dados da campanha:', {
                    nome: name,
                    codigo: campaignId,
                    guilda_id: userGuild.id,
                    guilda_nome: userGuild.name,
                    usuario: currentUser.id
                });
                
                // AGORA USA A FUN√á√ÉO RPC create_campaign
                console.log('üöÄ Chamando fun√ß√£o RPC create_campaign...');
                
                const { data: result, error } = await supabase.rpc('create_campaign', {
                    p_guild_id: userGuild.id,
                    p_name: name,
                    p_campaign_id: campaignId,
                    p_description: description || null,
                    p_setting: setting || null,
                    p_starting_points: startingPoints,
                    p_max_players: maxPlayers,
                    p_status: status
                });
                
                if (error) {
                    console.error('‚ùå Erro RPC:', error);
                    
                    // Fallback: Tenta m√©todo direto se RPC falhar
                    console.log('üîÑ Tentando m√©todo direto como fallback...');
                    
                    // Verifica se c√≥digo j√° existe
                    const { data: existingCampaign } = await supabase
                        .from('campaigns')
                        .select('campaign_id')
                        .eq('campaign_id', campaignId)
                        .single();
                    
                    if (existingCampaign) {
                        throw new Error('Este c√≥digo de campanha j√° est√° em uso. Gere um novo c√≥digo.');
                    }
                    
                    // Cria campanha diretamente
                    const { data: newCampaign, error: insertError } = await supabase
                        .from('campaigns')
                        .insert({
                            campaign_id: campaignId,
                            guild_id: userGuild.id,
                            name: name,
                            description: description || null,
                            setting: setting || null,
                            starting_points: startingPoints,
                            max_players: maxPlayers,
                            status: status,
                            created_by: currentUser.id,
                            game_system: 'GURPS'
                        })
                        .select()
                        .single();
                    
                    if (insertError) throw insertError;
                    
                    // Adiciona como co-gm
                    try {
                        await supabase
                            .from('campaign_players')
                            .insert({
                                campaign_id: newCampaign.id,
                                user_id: currentUser.id,
                                role: 'co-gm',
                                status: 'active',
                                joined_at: new Date().toISOString()
                            });
                    } catch (playerError) {
                        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel adicionar como mestre:', playerError);
                    }
                    
                    showMessage(`‚úÖ Campanha "${name}" criada com sucesso! C√≥digo: ${campaignId}`, 'success', 'gm-create-content');
                    
                } else {
                    // Sucesso com RPC
                    console.log('‚úÖ Resultado RPC:', result);
                    showMessage(`‚úÖ ${result.message} | C√≥digo: ${result.campaign_id}`, 'success', 'gm-create-content');
                }
                
                // LIMPA FORMUL√ÅRIO
                document.getElementById('campaignName').value = '';
                document.getElementById('campaignDescription').value = '';
                document.getElementById('campaignSetting').value = '';
                document.getElementById('startingPoints').value = '100';
                document.getElementById('maxPlayers').value = '6';
                document.getElementById('campaignStatus').value = 'preparation';
                generateCampaignId();
                
                // ATUALIZA LISTA E MUDA ABA
                setTimeout(() => {
                    loadGMCampaigns();
                    const gmCampaignsTab = document.querySelector('.sub-tab[data-sub-tab="gm-campaigns"]');
                    if (gmCampaignsTab) gmCampaignsTab.click();
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Erro ao criar campanha:', error);
                let errorMessage = '‚ùå Erro ao criar campanha: ';
                
                if (error.message.includes('guild')) {
                    errorMessage += 'Problema com a guilda. ';
                    errorMessage += `Guilda ID: ${userGuild?.id}, Nome: ${userGuild?.name}`;
                } else if (error.message.includes('permission')) {
                    errorMessage += 'Voc√™ n√£o tem permiss√£o para criar campanhas nesta guilda.';
                } else if (error.message.includes('c√≥digo') || error.message.includes('c√≥digo')) {
                    errorMessage += error.message;
                    generateCampaignId();
                } else {
                    errorMessage += error.message || 'Tente novamente.';
                }
                
                showMessage(errorMessage, 'error', 'gm-create-content');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        async function loadGMCampaigns() {
            const container = document.getElementById('gm-campaigns-list');
            if (!container) return;
            container.innerHTML = '<p style="color: #888; text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Carregando suas campanhas...</p>';
            try {
                // Tenta usar a fun√ß√£o RPC primeiro
                let campaigns = [];
                
                try {
                    const { data: rpcCampaigns, error: rpcError } = await supabase.rpc('get_user_gm_campaigns');
                    if (!rpcError && rpcCampaigns) {
                        campaigns = rpcCampaigns;
                        console.log('‚úÖ Campanhas carregadas via RPC');
                    } else {
                        throw rpcError;
                    }
                } catch (rpcError) {
                    console.log('üîÑ RPC falhou, usando query direta...', rpcError?.message);
                    
                    // Fallback para query direta
                    const { data: directCampaigns, error: directError } = await supabase
                        .from('campaigns')
                        .select(`
                            *,
                            guilds(name)
                        `)
                        .eq('created_by', currentUser.id)
                        .order('created_at', { ascending: false });
                    
                    if (directError) throw directError;
                    
                    campaigns = directCampaigns.map(c => ({
                        ...c,
                        guild_name: c.guilds?.name || 'Desconhecida'
                    }));
                }
                
                if (!campaigns || campaigns.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-hat-wizard"></i>
                            <h3>Nenhuma campanha encontrada</h3>
                            <p>Voc√™ ainda n√£o criou nenhuma campanha como mestre.</p>
                            <button class="btn" onclick="document.querySelector('.sub-tab[data-sub-tab=\"gm-create\"]').click()" style="margin-top: 20px;">
                                <i class="fas fa-plus-circle"></i> Criar Primeira Campanha
                            </button>
                        </div>
                    `;
                    return;
                }
                
                const campaignsWithPlayers = await Promise.all(
                    campaigns.map(async (campaign) => {
                        try {
                            const { count: playerCount } = await supabase
                                .from('campaign_players')
                                .select('*', { count: 'exact', head: true })
                                .eq('campaign_id', campaign.id)
                                .eq('status', 'active');
                            return {
                                ...campaign,
                                player_count: playerCount || 0,
                                max_players: campaign.max_players || 6,
                                starting_points: campaign.starting_points || 100,
                                guild_name: campaign.guild_name || 'Desconhecida'
                            };
                        } catch (countError) {
                            return {
                                ...campaign,
                                player_count: 0,
                                max_players: campaign.max_players || 6,
                                starting_points: campaign.starting_points || 100,
                                guild_name: campaign.guild_name || 'Desconhecida'
                            };
                        }
                    })
                );
                
                container.innerHTML = `
                    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="color: #ffd700;">${campaignsWithPlayers.length} Campanha${campaignsWithPlayers.length !== 1 ? 's' : ''}</h3>
                        <button class="btn" onclick="document.querySelector('.sub-tab[data-sub-tab=\"gm-create\"]').click()">
                            <i class="fas fa-plus-circle"></i> Nova Campanha
                        </button>
                    </div>
                    <div class="campaigns-grid">
                        ${campaignsWithPlayers.map(campaign => `
                            <div class="campaign-card">
                                <h3>${escapeHtml(campaign.name)}</h3>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div class="campaign-code">C√≥digo: ${campaign.campaign_id}</div>
                                    <span style="font-size: 0.8rem; color: #aaa;">
                                        <i class="fas fa-landmark"></i> ${escapeHtml(campaign.guild_name)}
                                    </span>
                                </div>
                                ${campaign.description ? `
                                    <div style="color: #bbb; margin-bottom: 10px; font-size: 0.9rem; line-height: 1.4;">
                                        ${escapeHtml(truncateText(campaign.description, 100))}
                                    </div>
                                ` : ''}
                                <div style="display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;">
                                    <span style="padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; 
                                        ${getStatusStyle(campaign.status)}">
                                        ${getStatusText(campaign.status)}
                                    </span>
                                    ${campaign.setting ? `
                                        <span style="padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; 
                                              background: rgba(255,140,0,0.1); color: #ff8c00;">
                                            ${escapeHtml(truncateText(campaign.setting, 20))}
                                        </span>
                                    ` : ''}
                                </div>
                                <div class="campaign-meta">
                                    <div class="campaign-stat">
                                        <i class="fas fa-users"></i>
                                        <span>${campaign.player_count}/${campaign.max_players}</span>
                                    </div>
                                    <div class="campaign-stat">
                                        <i class="fas fa-star"></i>
                                        <span>${campaign.starting_points} pts</span>
                                    </div>
                                    <div class="campaign-stat">
                                        <i class="fas fa-calendar"></i>
                                        <span>${formatDate(campaign.created_at)}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                    <button class="btn" style="flex: 1; padding: 8px 12px; font-size: 0.85rem;" 
                                            onclick="viewCampaignDetails('${campaign.id}')">
                                        <i class="fas fa-eye"></i> Ver
                                    </button>
                                    <button class="btn" style="flex: 1; padding: 8px 12px; font-size: 0.85rem; 
                                            background: rgba(52,152,219,0.8);" 
                                            onclick="manageCampaign('${campaign.id}')">
                                        <i class="fas fa-cog"></i> Gerenciar
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('‚ùå Erro ao carregar campanhas:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Erro ao carregar campanhas</h3>
                        <p>${error.message || 'Tente novamente mais tarde.'}</p>
                        <button class="btn" onclick="loadGMCampaigns()" style="margin-top: 20px;">
                            <i class="fas fa-redo"></i> Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }

        async function loadPlayerCampaigns() {
            const container = document.getElementById('player-campaigns-list');
            if (!container) return;
            container.innerHTML = '<p style="color: #888; text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin"></i> Carregando suas campanhas...</p>';
            try {
                // Tenta usar a fun√ß√£o RPC primeiro
                let campaigns = [];
                
                try {
                    const { data: rpcCampaigns, error: rpcError } = await supabase.rpc('get_user_player_campaigns');
                    if (!rpcError && rpcCampaigns) {
                        campaigns = rpcCampaigns;
                        console.log('‚úÖ Campanhas de jogador carregadas via RPC');
                    } else {
                        throw rpcError;
                    }
                } catch (rpcError) {
                    console.log('üîÑ RPC falhou, usando query direta...', rpcError?.message);
                    
                    // Fallback para query direta
                    const { data: memberships, error: queryError } = await supabase
                        .from('campaign_players')
                        .select(`
                            *,
                            campaigns!inner(*,
                                profiles!campaigns_created_by_fkey(username),
                                guilds(name)
                            )
                        `)
                        .eq('user_id', currentUser.id)
                        .eq('status', 'active')
                        .order('joined_at', { ascending: false });
                    
                    if (queryError) throw queryError;
                    
                    if (memberships && memberships.length > 0) {
                        campaigns = memberships
                            .filter(m => m.campaigns.created_by !== currentUser.id)
                            .map(m => ({
                                campaign_id: m.campaigns.campaign_id,
                                campaign_name: m.campaigns.name,
                                campaign_uuid: m.campaigns.id,
                                description: m.campaigns.description,
                                setting: m.campaigns.setting,
                                starting_points: m.campaigns.starting_points || 100,
                                status: m.campaigns.status,
                                gm_username: m.campaigns.profiles?.username || 'Desconhecido',
                                joined_at: m.joined_at,
                                role: m.role,
                                guild_name: m.campaigns.guilds?.name || 'Desconhecida'
                            }));
                    }
                }
                
                if (!campaigns || campaigns.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>Nenhuma campanha encontrada</h3>
                            <p>Voc√™ ainda n√£o est√° em nenhuma campanha como jogador.</p>
                            <p style="color: #777; font-size: 0.9rem; margin-top: 10px;">
                                Pe√ßa ao mestre da campanha para te convidar usando o c√≥digo da campanha.
                            </p>
                        </div>
                    `;
                    return;
                }
                
                // Conta jogadores para cada campanha
                const campaignsWithCounts = await Promise.all(
                    campaigns.map(async (campaign) => {
                        try {
                            const { count: playerCount } = await supabase
                                .from('campaign_players')
                                .select('*', { count: 'exact', head: true })
                                .eq('campaign_id', campaign.campaign_uuid)
                                .eq('status', 'active');
                            return {
                                ...campaign,
                                player_count: playerCount || 0
                            };
                        } catch (countError) {
                            return {
                                ...campaign,
                                player_count: 0
                            };
                        }
                    })
                );
                
                container.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #ffd700;">${campaignsWithCounts.length} Campanha${campaignsWithCounts.length !== 1 ? 's' : ''} como Jogador</h3>
                    </div>
                    <div class="campaigns-grid">
                        ${campaignsWithCounts.map(campaign => `
                            <div class="campaign-card">
                                <h3>${escapeHtml(campaign.campaign_name)}</h3>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div class="campaign-code" style="background: rgba(52,152,219,0.2); color: #3498db;">
                                        C√≥digo: ${campaign.campaign_id}
                                    </div>
                                    <span style="font-size: 0.8rem; color: #aaa;">
                                        <i class="fas fa-landmark"></i> ${escapeHtml(campaign.guild_name)}
                                    </span>
                                </div>
                                ${campaign.description ? `
                                    <div style="color: #bbb; margin-bottom: 10px; font-size: 0.9rem; line-height: 1.4;">
                                        ${escapeHtml(truncateText(campaign.description, 100))}
                                    </div>
                                ` : ''}
                                <p style="color: #aaa; margin-bottom: 10px; font-size: 0.85rem;">
                                    <i class="fas fa-crown" style="color: #ffd700;"></i> 
                                    Mestre: ${escapeHtml(campaign.gm_username)}
                                </p>
                                <div style="display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap;">
                                    <span style="padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; 
                                        ${getStatusStyle(campaign.status)}">
                                        ${getStatusText(campaign.status)}
                                    </span>
                                    ${campaign.setting ? `
                                        <span style="padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; 
                                              background: rgba(52,152,219,0.1); color: #3498db;">
                                            ${escapeHtml(truncateText(campaign.setting, 20))}
                                        </span>
                                    ` : ''}
                                </div>
                                <div class="campaign-meta">
                                    <div class="campaign-stat">
                                        <i class="fas fa-users"></i>
                                        <span>${campaign.player_count} jogadores</span>
                                    </div>
                                    <div class="campaign-stat">
                                        <i class="fas fa-star"></i>
                                        <span>${campaign.starting_points} pts</span>
                                    </div>
                                    <div class="campaign-stat">
                                        <i class="fas fa-sign-in-alt"></i>
                                        <span>${formatDate(campaign.joined_at)}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                    <button class="btn" style="flex: 1; padding: 8px 12px; font-size: 0.85rem;" 
                                            onclick="enterCampaign('${campaign.campaign_uuid}')">
                                        <i class="fas fa-door-open"></i> Entrar
                                    </button>
                                    <button class="btn" style="flex: 1; padding: 8px 12px; font-size: 0.85rem; 
                                            background: rgba(46,204,113,0.8);" 
                                            onclick="viewCharacterSheet('${campaign.campaign_uuid}')">
                                        <i class="fas fa-scroll"></i> Ficha
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('‚ùå Erro ao carregar campanhas:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Erro ao carregar campanhas</h3>
                        <p>${error.message || 'Tente novamente mais tarde.'}</p>
                        <button class="btn" onclick="loadPlayerCampaigns()" style="margin-top: 20px;">
                            <i class="fas fa-redo"></i> Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffTime = Math.abs(now - date);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays === 0) return 'Hoje';
                else if (diffDays === 1) return 'Ontem';
                else if (diffDays < 7) return `${diffDays} dias`;
                else return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
            } catch (error) {
                return 'Data inv√°lida';
            }
        }

        function getStatusStyle(status) {
            switch (status) {
                case 'active': return 'background: rgba(46,204,113,0.2); color: #2ecc71;';
                case 'preparation': return 'background: rgba(52,152,219,0.2); color: #3498db;';
                case 'paused': return 'background: rgba(241,196,15,0.2); color: #f1c40f;';
                case 'completed': return 'background: rgba(155,89,182,0.2); color: #9b59b6;';
                case 'archived': return 'background: rgba(149,165,166,0.2); color: #95a5a6;';
                default: return 'background: rgba(155,155,155,0.2); color: #aaa;';
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'active': 'Ativa',
                'preparation': 'Prepara√ß√£o',
                'paused': 'Pausada',
                'completed': 'Conclu√≠da',
                'archived': 'Arquivada'
            };
            return statusMap[status] || status;
        }

        function showMessage(text, type = 'info', containerId = null) {
            console.log(`üí¨ Mensagem [${type}]:`, text);
            const messageId = 'dynamic-message-' + (containerId || 'global');
            const oldMessage = document.getElementById(messageId);
            if (oldMessage) oldMessage.remove();
            const messageEl = document.createElement('div');
            messageEl.id = messageId;
            messageEl.className = `message ${type}`;
            messageEl.textContent = text;
            messageEl.setAttribute('role', 'alert');
            if (containerId) {
                const container = document.getElementById(containerId);
                if (container) {
                    const form = document.getElementById('createCampaignForm');
                    if (form) form.prepend(messageEl);
                }
            } else {
                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    const tabs = document.querySelector('.main-tabs');
                    if (tabs) mainContent.insertBefore(messageEl, tabs.nextSibling);
                }
            }
            if (type !== 'error') {
                setTimeout(() => {
                    if (messageEl.parentNode) {
                        messageEl.style.opacity = '0';
                        setTimeout(() => messageEl.remove(), 300);
                    }
                }, 5000);
            }
        }

        function viewCampaignDetails(campaignId) {
            showMessage(`üîç Abrindo detalhes da campanha...`, 'info');
            console.log('Ver detalhes da campanha:', campaignId);
        }

        function manageCampaign(campaignId) {
            showMessage(`‚öôÔ∏è Abrindo gerenciamento da campanha...`, 'info');
            console.log('Gerenciar campanha:', campaignId);
        }

        function enterCampaign(campaignId) {
            showMessage(`üö™ Entrando na campanha...`, 'info');
            console.log('Entrar na campanha:', campaignId);
        }

        function viewCharacterSheet(campaignId) {
            showMessage(`üìú Abrindo ficha de personagem...`, 'info');
            console.log('Ver ficha da campanha:', campaignId);
        }
        
        // Fun√ß√£o de debug para testar conex√£o
        async function debugConnection() {
            try {
                console.log('üîç Testando conex√£o com Supabase...');
                
                // Testa autentica√ß√£o
                const { data: session } = await supabase.auth.getSession();
                console.log('‚úÖ Sess√£o:', session ? 'Ativa' : 'Inativa');
                
                // Testa perfil
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                console.log('‚úÖ Perfil:', profile ? 'Encontrado' : 'N√£o encontrado');
                
                // Testa guilda
                console.log('‚úÖ Guilda do usu√°rio:', userGuild);
                
                // Testa fun√ß√£o RPC
                try {
                    const { data: testId } = await supabase.rpc('generate_campaign_id');
                    console.log('‚úÖ Fun√ß√£o generate_campaign_id:', testId);
                } catch (rpcError) {
                    console.log('‚ö†Ô∏è Fun√ß√£o RPC n√£o dispon√≠vel:', rpcError.message);
                }
                
            } catch (error) {
                console.error('‚ùå Erro no debug:', error);
            }
        }
        
        // Opcional: Adiciona bot√£o de debug
        window.debugCampaigns = debugConnection;
    </script>
</body>
</html>