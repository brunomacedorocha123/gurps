<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Guilda - RPG System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ESTILOS GERAIS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
        }

        body {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('Cris2.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* HEADER SIMPLIFICADO */
        .header {
            background: rgba(30, 30, 40, 0.95);
            padding: 12px 15px;
            border-bottom: 2px solid rgba(255, 140, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .logo h1 {
            font-size: 1.5rem;
            background: linear-gradient(45deg, #ffd700, #ff8c00, #ff4500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
        }

        .logo p {
            font-size: 0.8rem;
            color: #ccc;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: nowrap;
        }

        .header-btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .back-btn {
            background: rgba(52, 152, 219, 0.8);
            color: white;
        }

        .back-btn:hover, .back-btn:active {
            background: rgba(52, 152, 219, 1);
        }

        .logout-btn {
            background: rgba(231, 76, 60, 0.8);
            color: white;
        }

        .logout-btn:hover, .logout-btn:active {
            background: rgba(231, 76, 60, 1);
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            min-width: 35px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff8c00, #ff4500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            border: 2px solid rgba(255, 140, 0, 0.5);
            font-size: 0.9rem;
        }

        /* CONTEÚDO PRINCIPAL */
        .main-content {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 15px;
            flex: 1;
            width: 100%;
        }

        /* QUANDO NÃO TEM GUILDA */
        .no-guild-container {
            text-align: center;
            padding: 40px 20px;
            background: rgba(30, 30, 40, 0.7);
            border-radius: 12px;
            border: 2px solid rgba(255, 140, 0, 0.3);
            margin-top: 20px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .no-guild-icon {
            font-size: 3.5rem;
            color: rgba(255, 140, 0, 0.3);
            margin-bottom: 20px;
        }

        .no-guild-title {
            color: #ffd700;
            font-size: 1.4rem;
            margin-bottom: 10px;
        }

        .no-guild-text {
            color: #aaa;
            margin-bottom: 25px;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .create-guild-btn {
            padding: 12px 25px;
            background: linear-gradient(45deg, #ff8c00, #ff4500);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .create-guild-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 69, 0, 0.3);
        }

        /* HEADER DA GUILDA */
        .guild-header {
            background: rgba(30, 30, 40, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 140, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .guild-avatar {
            width: 80px;
            height: 80px;
            min-width: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff8c00, #ff4500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
            border: 3px solid rgba(255, 140, 0, 0.5);
        }

        .guild-info {
            flex: 1;
            min-width: 0;
        }

        .guild-name {
            color: #ffd700;
            font-size: 1.5rem;
            margin-bottom: 8px;
            word-break: break-word;
        }

        .guild-id {
            background: rgba(255, 140, 0, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-block;
            margin-bottom: 12px;
            font-family: monospace;
            word-break: break-all;
        }

        .guild-description {
            color: #ccc;
            font-style: italic;
            margin-bottom: 15px;
            line-height: 1.4;
            font-size: 0.9rem;
            word-break: break-word;
        }

        .guild-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .guild-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #aaa;
            font-size: 0.85rem;
        }

        .guild-stat i {
            color: #ff8c00;
            font-size: 0.9rem;
        }

        /* TABS DA GUILDA */
        .guild-tabs {
            display: flex;
            background: rgba(30, 30, 40, 0.8);
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 140, 0, 0.2);
            overflow: hidden;
            flex-wrap: wrap;
        }

        .guild-tab {
            flex: 1;
            min-width: 100px;
            padding: 12px 10px;
            text-align: center;
            background: none;
            border: none;
            color: #ccc;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .guild-tab:last-child {
            border-right: none;
        }

        .guild-tab:hover {
            background: rgba(255, 140, 0, 0.1);
            color: #ff8c00;
        }

        .guild-tab.active {
            background: rgba(255, 140, 0, 0.2);
            color: #ffd700;
            border-bottom: 3px solid #ff8c00;
        }

        /* CONTEÚDO DAS TABS */
        .tab-content {
            display: none;
            background: rgba(30, 30, 40, 0.7);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 140, 0, 0.2);
            margin-bottom: 25px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ABA MEMBROS */
        .members-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .members-count {
            color: #ff8c00;
            font-weight: bold;
            background: rgba(255, 140, 0, 0.1);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .members-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .member-card {
            background: rgba(40, 40, 50, 0.5);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .member-card:hover {
            border-color: rgba(255, 140, 0, 0.3);
            transform: translateY(-3px);
        }

        .member-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .member-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(45deg, #ff8c00, #ff4500);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .member-info {
            flex: 1;
            min-width: 0;
        }

        .member-name {
            color: white;
            font-weight: 600;
            margin-bottom: 4px;
            word-break: break-word;
        }

        .member-player-id {
            color: #aaa;
            font-size: 0.8rem;
            margin-bottom: 4px;
        }

        .member-role {
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            display: inline-block;
            font-weight: 600;
        }

        .role-owner {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .role-admin {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
            border: 1px solid rgba(46, 204, 113, 0.3);
        }

        .role-member {
            background: rgba(255, 140, 0, 0.2);
            color: #ff8c00;
            border: 1px solid rgba(255, 140, 0, 0.3);
        }

        .member-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .member-actions .btn {
            flex: 1;
            padding: 6px;
            font-size: 0.8rem;
        }

        /* ABA CONVITES */
        .invites-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .invites-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .invite-card {
            background: rgba(40, 40, 50, 0.5);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 140, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .invite-info {
            flex: 1;
            min-width: 200px;
        }

        .invite-info h4 {
            color: white;
            margin-bottom: 4px;
            font-size: 0.95rem;
            word-break: break-word;
        }

        .invite-info p {
            color: #aaa;
            font-size: 0.85rem;
            margin-bottom: 2px;
        }

        .invite-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        /* ABA CONFIGURAÇÕES */
        .settings-grid {
            display: grid;
            gap: 15px;
        }

        .settings-section {
            background: rgba(40, 40, 50, 0.5);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-section h3 {
            color: #ffd700;
            margin-bottom: 12px;
            font-size: 1.1rem;
            border-bottom: 1px solid rgba(255, 140, 0, 0.3);
            padding-bottom: 8px;
        }

        .settings-actions {
            display: grid;
            gap: 10px;
        }

        .settings-actions .btn {
            width: 100%;
            justify-content: center;
            padding: 10px;
        }

        .danger-zone {
            border-color: rgba(231, 76, 60, 0.3) !important;
        }

        .danger-zone h3 {
            color: #e74c3c;
            border-bottom-color: rgba(231, 76, 60, 0.3);
        }

        /* BOTÕES GERAIS */
        .btn {
            padding: 10px 16px;
            background: linear-gradient(45deg, #ff8c00, #ff4500);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            text-decoration: none;
        }

        .btn:hover, .btn:active {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 69, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #ccc;
        }

        .btn-secondary:hover, .btn-secondary:active {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: rgba(231, 76, 60, 0.8);
        }

        .btn-danger:hover, .btn-danger:active {
            background: rgba(231, 76, 60, 1);
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 0.8rem;
        }

        /* MODAIS */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(5px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 15px;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: rgba(30, 30, 40, 0.95);
            border-radius: 12px;
            padding: 20px;
            width: 100%;
            max-width: 450px;
            border: 1px solid rgba(255, 140, 0, 0.3);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 20px;
        }

        .modal-title {
            color: #ffd700;
            font-size: 1.3rem;
            margin-bottom: 6px;
        }

        .modal-subtitle {
            color: #aaa;
            font-size: 0.85rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            color: #ccc;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 140, 0, 0.3);
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #ff8c00;
            box-shadow: 0 0 0 2px rgba(255, 140, 0, 0.2);
        }

        .form-textarea {
            width: 100%;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 140, 0, 0.3);
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
            min-height: 80px;
            resize: vertical;
        }

        .form-note {
            color: #888;
            font-size: 0.75rem;
            margin-top: 4px;
            display: block;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-actions .btn {
            flex: 1;
            padding: 10px;
        }

        /* MODAL CONVIDAR */
        .invite-modal .modal {
            max-width: 400px;
        }

        /* MENSAGENS */
        .message {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            display: none;
        }

        .message.success {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid rgba(46, 204, 113, 0.3);
            color: #2ecc71;
            display: block;
        }

        .message.error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.3);
            color: #e74c3c;
            display: block;
        }

        .message.info {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid rgba(52, 152, 219, 0.3);
            color: #3498db;
            display: block;
        }

        /* FOOTER */
        .footer {
            background: rgba(20, 20, 30, 0.9);
            padding: 12px 0;
            text-align: center;
            margin-top: auto;
            border-top: 1px solid rgba(255, 140, 0, 0.2);
        }

        .footer p {
            color: #888;
            font-size: 0.8rem;
        }

        /* LOADING */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #ff8c00;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* RESPONSIVIDADE */
        @media (max-width: 768px) {
            html {
                font-size: 15px;
            }
            
            .header-content {
                flex-direction: row;
            }
            
            .logo h1 {
                font-size: 1.3rem;
            }
            
            .guild-header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
                padding: 15px;
            }
            
            .guild-avatar {
                width: 70px;
                height: 70px;
                font-size: 1.5rem;
            }
            
            .guild-name {
                font-size: 1.3rem;
            }
            
            .guild-tabs {
                flex-direction: row;
            }
            
            .guild-tab {
                flex: none;
                width: calc(100% / 3);
                min-width: auto;
                padding: 10px;
                font-size: 0.85rem;
            }
            
            .members-grid {
                grid-template-columns: 1fr;
            }
            
            .invite-card {
                flex-direction: column;
                text-align: center;
            }
            
            .invite-actions {
                width: 100%;
                justify-content: center;
            }
            
            .modal {
                padding: 15px;
                max-height: 90vh;
            }
            
            .modal-actions {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            html {
                font-size: 14px;
            }
            
            .header {
                padding: 10px;
            }
            
            .logo h1 {
                font-size: 1.2rem;
            }
            
            .user-menu {
                gap: 5px;
            }
            
            .header-btn {
                padding: 6px 8px;
                font-size: 0.8rem;
            }
            
            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
            }
            
            .guild-stat {
                width: 100%;
                justify-content: center;
            }
            
            .guild-tab {
                font-size: 0.8rem;
                padding: 8px 6px;
                gap: 4px;
            }
            
            .guild-tab i {
                font-size: 0.9rem;
            }
            
            .member-actions {
                flex-direction: column;
            }
            
            .modal {
                max-height: 95vh;
                margin: 0;
                border-radius: 10px 10px 0 0;
            }
            
            .modal-overlay {
                padding: 0;
                align-items: flex-end;
            }
            
            .main-content {
                padding: 0 10px;
            }
        }

        @media (max-width: 320px) {
            .guild-tab {
                font-size: 0.75rem;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
        }

        /* ORIENTAÇÃO LANDSCAPE */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                position: static;
            }
            
            .modal {
                max-height: 70vh;
            }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <h1>RPG SYSTEM</h1>
                <p>Guilda</p>
            </div>
            
            <div class="user-menu">
                <button class="header-btn back-btn" id="backBtn" aria-label="Voltar">
                    <i class="fas fa-arrow-left"></i>
                    <span class="text">Voltar</span>
                </button>
                
                <button class="header-btn logout-btn" id="logoutBtn" aria-label="Sair">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="text">Sair</span>
                </button>
                
                <div class="user-avatar" id="userAvatar" aria-label="Avatar do usuário">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- CONTEÚDO PRINCIPAL -->
    <main class="main-content">
        <div id="guild-content">
            <!-- Conteúdo carregado dinamicamente -->
        </div>
    </main>

    <!-- MODAL CRIAR GUILDA -->
    <div class="modal-overlay" id="createGuildModal" role="dialog" aria-labelledby="createGuildTitle" aria-hidden="true">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="createGuildTitle">Criar Nova Guilda</h3>
                <p class="modal-subtitle">Reúna seus amigos e crie sua própria guilda</p>
            </div>
            
            <form id="createGuildForm">
                <div class="form-group">
                    <label class="form-label" for="guildName">Nome da Guilda *</label>
                    <input type="text" class="form-input" id="guildName" required 
                           placeholder="Ex: Aventureiros do Reino" maxlength="100">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="guildId">ID da Guilda *</label>
                    <input type="text" class="form-input" id="guildId" required 
                           placeholder="Ex: aventura123" pattern="[a-z0-9_-]{3,50}" 
                           title="Apenas letras minúsculas, números, hífen (-) e underscore (_)">
                    <span class="form-note">3-50 caracteres: letras minúsculas, números, hífen (-) e underscore (_)</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="guildDescription">Descrição</label>
                    <textarea class="form-textarea" id="guildDescription" 
                              placeholder="Descreva sua guilda, objetivos, estilo de jogo..." maxlength="500"></textarea>
                    <span class="form-note">Opcional, máximo 500 caracteres</span>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="maxMembers">Limite de Membros</label>
                    <input type="number" class="form-input" id="maxMembers" 
                           value="10" min="3" max="20">
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelCreate">
                        Cancelar
                    </button>
                    <button type="submit" class="btn" id="submitCreate">
                        <i class="fas fa-plus"></i> Criar Guilda
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL CONVIDAR MEMBRO -->
    <div class="modal-overlay invite-modal" id="inviteModal" role="dialog" aria-labelledby="inviteTitle" aria-hidden="true">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="inviteTitle">Convidar para Guilda</h3>
                <p class="modal-subtitle">Convide jogadores usando o ID deles</p>
            </div>
            
            <form id="inviteForm">
                <div class="form-group">
                    <label class="form-label" for="invitePlayerId">ID do Jogador *</label>
                    <input type="text" class="form-input" id="invitePlayerId" required 
                           placeholder="Ex: 123456 (apenas números)" pattern="[0-9]+"
                           title="Digite apenas números (ex: 123456)">
                    <span class="form-note">Digite o ID numérico do jogador (ex: 123456)</span>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelInvite">
                        Cancelar
                    </button>
                    <button type="submit" class="btn" id="submitInvite">
                        <i class="fas fa-paper-plane"></i> Enviar Convite
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- FOOTER -->
    <footer class="footer">
        <p>RPG System &copy; 2024 - A vida imita GURPS</p>
    </footer>

    <script>
// Configuração do Supabase
const SUPABASE_URL = 'https://pujufdfhaxveuytkneqw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1anVmZGZoYXh2ZXV5dGtuZXF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNTkyODksImV4cCI6MjA3OTkzNTI4OX0.mzOwsmf8qIQ4HZqnXLEmq4D7M6fz4VH1YWpWP-BsFvc';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let currentUser = null;
let userGuild = null;
let guildMembers = [];
let guildInvites = [];

// Funções principais
async function initGuild() {
    showLoading();
    try {
        await checkAuth();
        await loadUserData();
        await loadUserGuild();
        setupEventListeners();
        hideLoading();
    } catch (error) {
        console.error('Erro na inicialização:', error);
        hideLoading();
        showMessage('Erro ao carregar guilda. Tente recarregar a página.', 'error');
    }
}

async function checkAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
        window.location.href = 'login.html';
        return;
    }
    currentUser = session.user;
}

async function loadUserData() {
    const { data: profile } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', currentUser.id)
        .single();

    if (profile) {
        const initials = profile.username?.charAt(0).toUpperCase() || 'U';
        document.getElementById('userAvatar').innerHTML = initials;
        document.getElementById('userAvatar').setAttribute('aria-label', `Usuário: ${profile.username || 'Anônimo'}`);
    }
}

async function loadUserGuild() {
    try {
        // Primeiro, verificar se é dono de alguma guilda
        const { data: ownedGuild, error: ownerError } = await supabase
            .from('guilds')
            .select('*')
            .eq('owner_id', currentUser.id)
            .maybeSingle();

        if (ownerError) {
            console.error('Erro ao buscar guilda do dono:', ownerError);
        }

        if (ownedGuild) {
            userGuild = ownedGuild;
            renderGuildPage();
            return;
        }

        // Se não for dono, verificar se é membro
        const { data: memberships, error: memberError } = await supabase
            .from('guild_members')
            .select(`
                guild_id,
                role,
                status,
                guilds(*)
            `)
            .eq('user_id', currentUser.id)
            .eq('status', 'accepted');

        if (memberError) {
            console.error('Erro ao buscar membros:', memberError);
            renderNoGuildPage();
            return;
        }

        if (memberships && memberships.length > 0) {
            userGuild = memberships[0].guilds;
            renderGuildPage();
        } else {
            renderNoGuildPage();
        }
    } catch (error) {
        console.error('Erro ao carregar guilda:', error);
        renderNoGuildPage();
    }
}

function renderNoGuildPage() {
    const content = `
        <div class="no-guild-container">
            <div class="no-guild-icon" aria-hidden="true">
                <i class="fas fa-users"></i>
            </div>
            <h2 class="no-guild-title">Você não possui uma guilda</h2>
            <p class="no-guild-text">
                Crie sua própria guilda para reunir seus amigos e jogadores.<br>
                Como dono da guilda, você poderá convidar outros jogadores, 
                gerenciar membros e organizar campanhas.
            </p>
            <button class="btn create-guild-btn" id="createGuildBtn" aria-label="Criar nova guilda">
                <i class="fas fa-plus"></i> Criar Guilda
            </button>
        </div>
    `;
    
    document.getElementById('guild-content').innerHTML = content;
    
    document.getElementById('createGuildBtn')?.addEventListener('click', () => {
        openModal('createGuildModal');
    });
}

function renderGuildPage() {
    const content = `
        <div class="guild-header">
            <div class="guild-avatar" aria-hidden="true">
                <i class="fas fa-users"></i>
            </div>
            <div class="guild-info">
                <h2 class="guild-name">${escapeHtml(userGuild.name)}</h2>
                <div class="guild-id">ID: ${escapeHtml(userGuild.custom_id)}</div>
                <p class="guild-description">${escapeHtml(userGuild.description || 'Sem descrição')}</p>
                <div class="guild-stats">
                    <div class="guild-stat">
                        <i class="fas fa-users"></i>
                        <span>Membros: <span id="memberCount">0</span>/${userGuild.max_members}</span>
                    </div>
                    <div class="guild-stat">
                        <i class="fas fa-crown"></i>
                        <span>Dono: ${userGuild.owner_id === currentUser.id ? 'Você' : 'Outro'}</span>
                    </div>
                    <div class="guild-stat">
                        <i class="fas fa-calendar"></i>
                        <span>Criada: ${formatDate(userGuild.created_at)}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="guild-tabs" role="tablist">
            <button class="guild-tab active" data-tab="members" role="tab" aria-selected="true" aria-controls="tab-members" id="tab-members-btn">
                <i class="fas fa-users"></i> <span class="tab-text">Membros</span>
            </button>
            <button class="guild-tab" data-tab="invites" role="tab" aria-selected="false" aria-controls="tab-invites" id="tab-invites-btn">
                <i class="fas fa-user-plus"></i> <span class="tab-text">Convites</span>
            </button>
            <button class="guild-tab" data-tab="settings" role="tab" aria-selected="false" aria-controls="tab-settings" id="tab-settings-btn">
                <i class="fas fa-cog"></i> <span class="tab-text">Configurações</span>
            </button>
        </div>

        <div id="tab-contents">
            <div class="tab-content active" id="tab-members" role="tabpanel" aria-labelledby="tab-members-btn">
                <div class="members-container">
                    <div class="members-header">
                        <h3 style="color: #ffd700;">Membros da Guilda</h3>
                        ${userGuild.owner_id === currentUser.id ? 
                            `<button class="btn" id="inviteMemberBtn" aria-label="Convidar novo membro">
                                <i class="fas fa-user-plus"></i> <span class="btn-text">Convidar</span>
                            </button>` : ''
                        }
                    </div>
                    <div class="members-grid" id="membersGrid">
                        <p style="color: #888; text-align: center;">Carregando membros...</p>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tab-invites" role="tabpanel" aria-labelledby="tab-invites-btn" hidden>
                <div class="invites-container">
                    <h3 style="color: #ffd700; margin-bottom: 20px;">Convites Enviados</h3>
                    <div id="invitesList">
                        <p style="color: #888; text-align: center;">Carregando convites...</p>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tab-settings" role="tabpanel" aria-labelledby="tab-settings-btn" hidden>
                <div class="members-container">
                    <h3 style="color: #ffd700; margin-bottom: 20px;">Configurações da Guilda</h3>
                    ${userGuild.owner_id === currentUser.id ? renderOwnerSettings() : renderMemberSettings()}
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('guild-content').innerHTML = content;
    setupTabs();
    loadMembers();
    loadInvites();
}

function renderOwnerSettings() {
    return `
        <div style="display: grid; gap: 15px;">
            <div class="settings-section">
                <h3>Ações da Guilda</h3>
                <div class="settings-actions">
                    <button class="btn" id="editGuildBtn">
                        <i class="fas fa-edit"></i> Editar Guilda
                    </button>
                    <button class="btn" id="transferGuildBtn">
                        <i class="fas fa-exchange-alt"></i> Transferir Guilda
                    </button>
                </div>
            </div>
            
            <div class="settings-section danger-zone">
                <h3>Zona de Perigo</h3>
                <div class="settings-actions">
                    <button class="btn btn-danger" id="deleteGuildBtn">
                        <i class="fas fa-trash"></i> Excluir Guilda
                    </button>
                </div>
            </div>
            
            <div class="settings-section">
                <h3>Informações da Guilda</h3>
                <div style="color: #aaa; font-size: 0.9rem;">
                    <p style="margin-bottom: 5px;">
                        <strong>ID:</strong> ${userGuild.custom_id}
                    </p>
                    <p style="margin-bottom: 5px;">
                        <strong>Código de Convite:</strong> <span id="inviteCodeSpan">${userGuild.invite_code || 'Gerando...'}</span>
                        <button class="btn btn-small" id="copyInviteCode" style="margin-left: 5px; padding: 2px 6px; font-size: 0.75rem;">
                            <i class="fas fa-copy"></i>
                        </button>
                    </p>
                    <p style="margin-bottom: 5px;">
                        <strong>Criada em:</strong> ${formatDate(userGuild.created_at)}
                    </p>
                    <p>
                        <strong>Última atualização:</strong> ${formatDate(userGuild.updated_at)}
                    </p>
                </div>
            </div>
        </div>
    `;
}

function renderMemberSettings() {
    return `
        <div class="settings-section danger-zone" style="text-align: center; padding: 30px 15px;">
            <h3>Sair da Guilda</h3>
            <p style="color: #aaa; margin-bottom: 20px;">
                Você não é o dono desta guilda. Apenas o dono pode alterar as configurações.
            </p>
            <button class="btn btn-danger" id="leaveGuildBtn">
                <i class="fas fa-sign-out-alt"></i> Sair da Guilda
            </button>
        </div>
    `;
}

function setupTabs() {
    const tabs = document.querySelectorAll('.guild-tab[data-tab]');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.getAttribute('data-tab');
            
            // Atualiza tabs
            tabs.forEach(t => {
                const isSelected = t === tab;
                t.classList.toggle('active', isSelected);
                t.setAttribute('aria-selected', isSelected);
                t.setAttribute('tabindex', isSelected ? '0' : '-1');
            });
            
            // Atualiza conteúdo
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => {
                const isActive = content.id === `tab-${tabId}`;
                content.classList.toggle('active', isActive);
                content.hidden = !isActive;
            });
        });
    });
}

async function loadMembers() {
    try {
        const membersGrid = document.getElementById('membersGrid');
        if (!membersGrid) return;
        
        membersGrid.innerHTML = '<p style="color: #888; text-align: center;"><span class="loading"></span> Carregando...</p>';
        
        const { data: members, error } = await supabase
            .from('guild_members_with_profiles')
            .select('*')
            .eq('guild_id', userGuild.id)
            .eq('status', 'accepted');

        if (error) {
            console.error('Erro ao carregar membros:', error);
            membersGrid.innerHTML = '<p style="color: #e74c3c; text-align: center;">Erro ao carregar membros</p>';
            return;
        }

        guildMembers = members || [];

        if (guildMembers.length === 0) {
            membersGrid.innerHTML = '<p style="color: #888; text-align: center;">Nenhum membro na guilda</p>';
        } else {
            membersGrid.innerHTML = guildMembers.map(member => `
                <div class="member-card" data-member-id="${member.id}">
                    <div class="member-header">
                        <div class="member-avatar" aria-label="Avatar de ${escapeHtml(member.username || 'Usuário')}">
                            ${member.username?.charAt(0).toUpperCase() || '?'}
                        </div>
                        <div class="member-info">
                            <div class="member-name">${escapeHtml(member.username || 'Usuário')}</div>
                            <div class="member-player-id">#${escapeHtml(member.player_id || '')}</div>
                            <div class="member-role ${'role-' + member.role}" aria-label="Cargo: ${member.role === 'owner' ? 'Dono' : member.role === 'admin' ? 'Administrador' : 'Membro'}">
                                ${member.role === 'owner' ? 'Dono' : member.role === 'admin' ? 'Administrador' : 'Membro'}
                            </div>
                        </div>
                    </div>
                    ${userGuild.owner_id === currentUser.id && member.user_id !== currentUser.id ? `
                        <div class="member-actions">
                            ${member.role === 'member' ? `
                                <button class="btn btn-small" onclick="promoteToAdmin('${member.id}', '${escapeHtml(member.username)}')" aria-label="Promover ${escapeHtml(member.username)} a Administrador">
                                    <i class="fas fa-star"></i> Promover
                                </button>
                            ` : member.role === 'admin' ? `
                                <button class="btn btn-small" onclick="demoteToMember('${member.id}', '${escapeHtml(member.username)}')" aria-label="Rebaixar ${escapeHtml(member.username)} a Membro">
                                    <i class="fas fa-arrow-down"></i> Rebaixar
                                </button>
                            ` : ''}
                            <button class="btn btn-danger btn-small" onclick="kickMember('${member.id}', '${escapeHtml(member.username)}')" aria-label="Expulsar ${escapeHtml(member.username)} da guilda">
                                <i class="fas fa-user-slash"></i> Expulsar
                            </button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        const memberCount = document.getElementById('memberCount');
        if (memberCount) {
            memberCount.textContent = guildMembers.length;
        }
    } catch (error) {
        console.error('Erro ao carregar membros:', error);
        const membersGrid = document.getElementById('membersGrid');
        if (membersGrid) {
            membersGrid.innerHTML = '<p style="color: #e74c3c; text-align: center;">Erro ao carregar membros</p>';
        }
    }
}

async function loadInvites() {
    try {
        const invitesList = document.getElementById('invitesList');
        if (!invitesList) return;
        
        invitesList.innerHTML = '<p style="color: #888; text-align: center;"><span class="loading"></span> Carregando...</p>';
        
        const { data: invites, error } = await supabase
            .from('guild_invitations_with_details')
            .select('*')
            .eq('guild_id', userGuild.id)
            .eq('status', 'pending');

        if (error) {
            console.error('Erro ao carregar convites:', error);
            invitesList.innerHTML = '<p style="color: #e74c3c; text-align: center;">Erro ao carregar convites</p>';
            return;
        }

        guildInvites = invites || [];

        if (guildInvites.length === 0) {
            invitesList.innerHTML = '<p style="color: #888; text-align: center;">Nenhum convite pendente</p>';
        } else {
            invitesList.innerHTML = guildInvites.map(invite => `
                <div class="invite-card" data-invite-id="${invite.id}">
                    <div class="invite-info">
                        <h4>Para: ${escapeHtml(invite.receiver_username || 'Usuário')}</h4>
                        <p>ID: #${escapeHtml(invite.receiver_player_id || '')}</p>
                        <p>Enviado em: ${formatDate(invite.sent_at)}</p>
                        ${invite.message ? `<p>Mensagem: ${escapeHtml(invite.message)}</p>` : ''}
                    </div>
                    <div class="invite-actions">
                        <button class="btn btn-danger btn-small" onclick="cancelInvite('${invite.id}', '${escapeHtml(invite.receiver_username)}')" aria-label="Cancelar convite para ${escapeHtml(invite.receiver_username)}">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error('Erro ao carregar convites:', error);
        const invitesList = document.getElementById('invitesList');
        if (invitesList) {
            invitesList.innerHTML = '<p style="color: #e74c3c; text-align: center;">Erro ao carregar convites</p>';
        }
    }
}

function setupEventListeners() {
    // Botões do header
    document.getElementById('backBtn')?.addEventListener('click', () => {
        window.location.href = 'home.html';
    });
    
    document.getElementById('logoutBtn')?.addEventListener('click', async () => {
        if (!confirm('Tem certeza que deseja sair?')) return;
        
        try {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        } catch (error) {
            console.error('Erro ao sair:', error);
            showMessage('Erro ao sair. Tente novamente.', 'error');
        }
    });
    
    // Modal criar guilda
    const createForm = document.getElementById('createGuildForm');
    if (createForm) {
        createForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await createGuild();
        });
    }
    
    document.getElementById('cancelCreate')?.addEventListener('click', () => {
        closeModal('createGuildModal');
        clearCreateForm();
    });
    
    // Modal convidar
    document.addEventListener('click', (e) => {
        if (e.target.closest('#inviteMemberBtn')) {
            openModal('inviteModal');
        }
    });
    
    const inviteForm = document.getElementById('inviteForm');
    if (inviteForm) {
        inviteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await sendInvite();
        });
    }
    
    document.getElementById('cancelInvite')?.addEventListener('click', () => {
        closeModal('inviteModal');
        document.getElementById('invitePlayerId').value = '';
    });
    
    // Configurações
    document.addEventListener('click', (e) => {
        if (e.target.closest('#editGuildBtn')) {
            editGuild();
        }
        if (e.target.closest('#transferGuildBtn')) {
            transferGuild();
        }
        if (e.target.closest('#deleteGuildBtn')) {
            deleteGuild();
        }
        if (e.target.closest('#leaveGuildBtn')) {
            leaveGuild();
        }
        if (e.target.closest('#copyInviteCode')) {
            copyInviteCode();
        }
    });
    
    // Fechar modais ao clicar fora
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal(modal.id);
                if (modal.id === 'createGuildModal') {
                    clearCreateForm();
                }
            }
        });
    });
    
    // Fechar modais com ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const openModal = document.querySelector('.modal-overlay.active');
            if (openModal) {
                closeModal(openModal.id);
                if (openModal.id === 'createGuildModal') {
                    clearCreateForm();
                }
            }
        }
    });
}

// FUNÇÃO CORRIGIDA - CRIAR GUILDA
async function createGuild() {
    const nameInput = document.getElementById('guildName');
    const idInput = document.getElementById('guildId');
    const descInput = document.getElementById('guildDescription');
    const maxMembersInput = document.getElementById('maxMembers');
    const submitBtn = document.getElementById('submitCreate');
    
    const name = nameInput.value.trim();
    const customId = idInput.value.trim().toLowerCase();
    const description = descInput.value.trim();
    const maxMembers = parseInt(maxMembersInput.value) || 10;
    
    try {
        // Validação
        if (!name || !customId) {
            showMessage('Nome e ID da guilda são obrigatórios', 'error');
            return;
        }
        
        if (customId.length < 3) {
            showMessage('ID da guilda deve ter pelo menos 3 caracteres', 'error');
            idInput.focus();
            return;
        }
        
        if (!/^[a-z0-9][a-z0-9_-]*$/.test(customId)) {
            showMessage('ID da guilda só pode conter letras minúsculas, números, hífen (-) e underscore (_)', 'error');
            idInput.focus();
            return;
        }
        
        // Desabilita botão durante a criação
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="loading"></span> Criando...';
        submitBtn.disabled = true;
        
        // Chama a função do banco de dados
        const { data: guildId, error } = await supabase.rpc('create_guild_with_owner', {
            p_custom_id: customId,
            p_name: name,
            p_description: description || null,
            p_max_members: maxMembers,
            p_image_url: null
        });
        
        // Restaura botão
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        if (error) {
            console.error('Erro ao criar guilda:', error);
            showMessage('Erro ao criar guilda: ' + error.message, 'error');
            return;
        }
        
        showMessage('Guilda criada com sucesso!', 'success');
        closeModal('createGuildModal');
        clearCreateForm();
        
        // Recarrega a página após um breve delay
        setTimeout(() => {
            window.location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('Erro ao criar guilda:', error);
        showMessage('Erro inesperado: ' + error.message, 'error');
        
        // Restaura botão em caso de erro
        const submitBtn = document.getElementById('submitCreate');
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-plus"></i> Criar Guilda';
            submitBtn.disabled = false;
        }
    }
}

// FUNÇÃO CORRIGIDA - ENVIAR CONVITE
async function sendInvite() {
    const playerIdInput = document.getElementById('invitePlayerId');
    const submitBtn = document.getElementById('submitInvite');
    
    const playerId = playerIdInput.value.trim();
    
    try {
        if (!playerId) {
            showMessage('Digite o ID do jogador', 'error', 'inviteModal');
            return;
        }
        
        // Valida se é número
        if (!/^\d+$/.test(playerId)) {
            showMessage('ID do jogador deve conter apenas números', 'error', 'inviteModal');
            playerIdInput.focus();
            return;
        }
        
        // Desabilita botão durante o envio
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="loading"></span> Enviando...';
        submitBtn.disabled = true;
        
        const { data, error } = await supabase.rpc('invite_to_guild', {
            p_guild_id: userGuild.id,
            p_receiver_player_id: playerId
        });
        
        // Restaura botão
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        if (error) {
            console.error('Erro ao enviar convite:', error);
            showMessage('Erro: ' + error.message, 'error', 'inviteModal');
            return;
        }
        
        closeModal('inviteModal');
        playerIdInput.value = '';
        
        showMessage('Convite enviado com sucesso!', 'success');
        
        // Recarrega lista de convites
        await loadInvites();
        
    } catch (error) {
        console.error('Erro ao enviar convite:', error);
        showMessage('Erro: ' + error.message, 'error', 'inviteModal');
        
        // Restaura botão em caso de erro
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Convite';
            submitBtn.disabled = false;
        }
    }
}

// FUNÇÃO CORRIGIDA - CANCELAR CONVITE
async function cancelInvite(invitationId, receiverName) {
    if (!confirm(`Cancelar convite para ${receiverName}?`)) {
        return;
    }
    
    try {
        const { error } = await supabase
            .from('guild_invitations')
            .update({ 
                status: 'cancelled',
                responded_at: new Date().toISOString()
            })
            .eq('id', invitationId);
        
        if (error) {
            console.error('Erro ao cancelar convite:', error);
            showMessage('Erro ao cancelar convite', 'error');
            return;
        }
        
        showMessage('Convite cancelado com sucesso!', 'success');
        await loadInvites();
        
    } catch (error) {
        console.error('Erro ao cancelar convite:', error);
        showMessage('Erro: ' + error.message, 'error');
    }
}

// FUNÇÃO CORRIGIDA - PROMOVER A ADMIN
async function promoteToAdmin(membershipId, memberName) {
    if (!confirm(`Promover ${memberName} a Administrador?\n\nAdministradores podem gerenciar membros, mas não podem excluir a guilda.`)) {
        return;
    }
    
    try {
        // Usa a função do banco de dados
        const { data, error } = await supabase.rpc('update_guild_member_role', {
            p_membership_id: membershipId,
            p_new_role: 'admin'
        });
        
        if (error) {
            console.error('Erro ao promover membro:', error);
            showMessage('Erro: ' + error.message, 'error');
            return;
        }
        
        showMessage(`${memberName} promovido a Administrador!`, 'success');
        await loadMembers();
        
    } catch (error) {
        console.error('Erro ao promover membro:', error);
        showMessage('Erro: ' + error.message, 'error');
    }
}

// FUNÇÃO CORRIGIDA - REBAIXAR A MEMBRO
async function demoteToMember(membershipId, memberName) {
    if (!confirm(`Rebaixar ${memberName} a Membro?\n\nEle perderá os privilégios de administrador.`)) {
        return;
    }
    
    try {
        // Usa a função do banco de dados
        const { data, error } = await supabase.rpc('update_guild_member_role', {
            p_membership_id: membershipId,
            p_new_role: 'member'
        });
        
        if (error) {
            console.error('Erro ao rebaixar membro:', error);
            showMessage('Erro: ' + error.message, 'error');
            return;
        }
        
        showMessage(`${memberName} rebaixado a Membro!`, 'success');
        await loadMembers();
        
    } catch (error) {
        console.error('Erro ao rebaixar membro:', error);
        showMessage('Erro: ' + error.message, 'error');
    }
}

// FUNÇÃO CORRIGIDA - EXPULSAR MEMBRO (ATUALIZADA)
async function kickMember(membershipId, memberName) {
    if (!confirm(`Expulsar ${memberName} da guilda?\n\nEsta ação não pode ser desfeita.`)) {
        return;
    }
    
    try {
        // PRIMEIRO: Tenta usar a função do banco de dados (expel_guild_member)
        const { data, error } = await supabase.rpc('expel_guild_member', {
            p_membership_id: membershipId
        });
        
        if (error) {
            console.error('Erro ao expulsar membro (via função):', error);
            
            // SEGUNDO: Se a função falhar, tenta excluir diretamente
            const { error: deleteError } = await supabase
                .from('guild_members')
                .delete()
                .eq('id', membershipId);
            
            if (deleteError) {
                console.error('Erro ao excluir membro:', deleteError);
                
                // TERCEIRO: Se excluir falhar, tenta atualizar o status
                const { error: updateError } = await supabase
                    .from('guild_members')
                    .update({ 
                        status: 'rejected',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', membershipId);
                
                if (updateError) {
                    console.error('Erro ao atualizar status:', updateError);
                    showMessage('Erro ao expulsar membro. Tente novamente.', 'error');
                    return;
                }
                
                showMessage('Membro removido da guilda!', 'success');
            } else {
                showMessage(`${memberName} foi expulso da guilda!`, 'success');
            }
        } else {
            showMessage(`${memberName} foi expulso da guilda!`, 'success');
        }
        
        // Recarrega a lista de membros
        await loadMembers();
        
    } catch (error) {
        console.error('Erro ao expulsar membro:', error);
        showMessage('Erro: ' + error.message, 'error');
    }
}

// FUNÇÃO EDITAR GUILDA
async function editGuild() {
    showMessage('Funcionalidade de edição da guilda será implementada em breve!', 'info');
}

// FUNÇÃO TRANSFERIR GUILDA
async function transferGuild() {
    showMessage('Funcionalidade de transferência da guilda será implementada em breve!', 'info');
}

// FUNÇÃO EXCLUIR GUILDA
async function deleteGuild() {
    if (!confirm('ATENÇÃO: Tem certeza que deseja EXCLUIR esta guilda?\n\n❌ Esta ação é PERMANENTE e NÃO pode ser desfeita!\n❌ Todos os membros serão removidos\n❌ Todos os dados da guilda serão apagados\n\nDigite "EXCLUIR" para confirmar:')) {
        return;
    }
    
    const confirmation = prompt('Digite "EXCLUIR" para confirmar a exclusão:');
    if (confirmation !== 'EXCLUIR') {
        showMessage('Exclusão cancelada.', 'info');
        return;
    }
    
    try {
        const { error } = await supabase
            .from('guilds')
            .delete()
            .eq('id', userGuild.id)
            .eq('owner_id', currentUser.id);
        
        if (error) {
            console.error('Erro ao excluir guilda:', error);
            showMessage('Erro ao excluir guilda: ' + error.message, 'error');
            return;
        }
        
        showMessage('Guilda excluída com sucesso!', 'success');
        setTimeout(() => {
            window.location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('Erro ao excluir guilda:', error);
        showMessage('Erro: ' + error.message, 'error');
    }
}

// FUNÇÃO SAIR DA GUILDA
async function leaveGuild() {
    if (!confirm('Tem certeza que deseja sair desta guilda?\n\nVocê perderá acesso a todos os recursos da guilda.')) {
        return;
    }
    
    try {
        // Usa a função do banco de dados
        const { data, error } = await supabase.rpc('leave_guild', {
            p_guild_id: userGuild.id
        });
        
        if (error) {
            console.error('Erro ao sair da guilda:', error);
            showMessage('Erro: ' + error.message, 'error');
            return;
        }
        
        showMessage('Você saiu da guilda!', 'success');
        setTimeout(() => {
            window.location.reload();
        }, 1500);
        
    } catch (error) {
        console.error('Erro ao sair da guilda:', error);
        showMessage('Erro: ' + error.message, 'error');
    }
}

// FUNÇÃO COPIAR CÓDIGO DE CONVITE
async function copyInviteCode() {
    const inviteCodeSpan = document.getElementById('inviteCodeSpan');
    if (!inviteCodeSpan) return;
    
    const inviteCode = inviteCodeSpan.textContent;
    
    try {
        await navigator.clipboard.writeText(inviteCode);
        showMessage('Código de convite copiado!', 'success');
    } catch (error) {
        console.error('Erro ao copiar código:', error);
        showMessage('Erro ao copiar código', 'error');
    }
}

// FUNÇÕES AUXILIARES
function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.add('active');
        modal.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        
        // Foca no primeiro input
        const firstInput = modal.querySelector('input, textarea, button');
        if (firstInput) {
            setTimeout(() => firstInput.focus(), 100);
        }
    }
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.remove('active');
        modal.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
    }
}

function clearCreateForm() {
    document.getElementById('guildName').value = '';
    document.getElementById('guildId').value = '';
    document.getElementById('guildDescription').value = '';
    document.getElementById('maxMembers').value = '10';
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateString) {
    if (!dateString) return 'Data desconhecida';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (error) {
        return 'Data inválida';
    }
}

function showMessage(text, type = 'info', container = 'guild-content') {
    const containerEl = document.getElementById(container) || document.body;
    
    // Remove mensagens anteriores
    const oldMessage = containerEl.querySelector('.message');
    if (oldMessage) {
        oldMessage.remove();
    }
    
    // Cria nova mensagem
    const messageEl = document.createElement('div');
    messageEl.className = `message ${type}`;
    messageEl.textContent = text;
    messageEl.setAttribute('role', 'alert');
    
    // Adiciona ao container
    if (container === 'guild-content') {
        containerEl.prepend(messageEl);
    } else {
        const modal = document.getElementById(container);
        if (modal) {
            const modalContent = modal.querySelector('.modal');
            if (modalContent) {
                modalContent.prepend(messageEl);
            }
        }
    }
    
    // Remove automaticamente após 5 segundos
    setTimeout(() => {
        if (messageEl.parentNode) {
            messageEl.style.opacity = '0';
            setTimeout(() => messageEl.remove(), 300);
        }
    }, 5000);
}

function showLoading() {
    // Implementação opcional de loading
}

function hideLoading() {
    // Implementação opcional de loading
}

// Inicializar quando o DOM estiver pronto
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGuild);
} else {
    initGuild();
}
    </script>
</body>
</html>