<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meus Personagens - RPG System</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }


    body {
      background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('Cris2.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      min-height: 100vh;
    }


    /* Header */
    .header {
      background: rgba(30, 30, 40, 0.9);
      padding: 15px 0;
      border-bottom: 2px solid rgba(255, 140, 0, 0.3);
      backdrop-filter: blur(10px);
    }


    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
    }


    .logo h1 {
      font-size: 1.8rem;
      background: linear-gradient(45deg, #ffd700, #ff8c00, #ff4500);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }


    .user-menu {
      display: flex;
      align-items: center;
      gap: 15px;
    }


    .btn-voltar {
      color: #ff8c00;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 15px;
      border: 1px solid rgba(255, 140, 0, 0.3);
      border-radius: 8px;
      transition: all 0.3s ease;
    }


    .btn-voltar:hover {
      background: rgba(255, 140, 0, 0.1);
    }


    /* Main Content */
    .main-content {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }


    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }


    .page-title {
      font-size: 2rem;
      color: #ffd700;
    }


    .btn-novo-personagem {
      background: linear-gradient(45deg, #ff8c00, #ff4500);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
    }


    .btn-novo-personagem:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(255, 69, 0, 0.3);
    }


    /* Personagens Grid */
    .personagens-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 25px;
      margin-bottom: 40px;
    }


    /* Card de Personagem - ATUALIZADO */
    .personagem-card {
      background: rgba(30, 30, 40, 0.8);
      border-radius: 15px;
      padding: 25px;
      border: 1px solid rgba(255, 140, 0, 0.2);
      transition: all 0.3s ease;
      position: relative;
      backdrop-filter: blur(10px);
      display: flex;
      flex-direction: column;
      height: 100%;
    }


    .personagem-card:hover {
      transform: translateY(-5px);
      border-color: rgba(255, 140, 0, 0.5);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }


    .card-topo {
      display: flex;
      align-items: flex-start;
      gap: 20px;
      margin-bottom: 20px;
    }


    /* Foto do Personagem */
    .personagem-foto {
      width: 100px;
      height: 100px;
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid rgba(255, 140, 0, 0.3);
      flex-shrink: 0;
    }


    .foto-placeholder {
      width: 100%;
      height: 100%;
      background: rgba(20, 20, 30, 0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #ff8c00;
      font-size: 0.8rem;
    }


    .foto-placeholder i {
      font-size: 2.5rem;
      margin-bottom: 5px;
    }


    .personagem-foto img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }


    .card-info {
      flex: 1;
    }


    .personagem-nome {
      font-size: 1.5rem;
      color: #ffd700;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }


    .nome-classe {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }


    .personagem-classe {
      font-size: 1rem;
      color: #ff8c00;
      font-weight: 600;
      padding: 4px 12px;
      background: rgba(255, 140, 0, 0.1);
      border-radius: 20px;
      border: 1px solid rgba(255, 140, 0, 0.3);
      display: inline-block;
      width: fit-content;
    }


    .personagem-raca {
      font-size: 0.9rem;
      color: #ccc;
      margin-bottom: 10px;
    }


    .personagem-status {
      background: rgba(255, 140, 0, 0.2);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      border: 1px solid rgba(255, 140, 0, 0.5);
      display: inline-block;
    }


    /* Informações do Personagem */
    .personagem-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(20, 20, 30, 0.6);
      border-radius: 10px;
    }


    .info-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }


    .info-label {
      font-size: 0.8rem;
      color: #ccc;
    }


    .info-value {
      font-weight: 600;
      color: #ff8c00;
    }


    /* Atributos Rápidos */
    .atributos-rapidos {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(20, 20, 30, 0.6);
      border-radius: 10px;
    }


    .atributo {
      text-align: center;
    }


    .atributo-valor {
      font-size: 1.4rem;
      font-weight: bold;
      color: #ffd700;
      margin-bottom: 3px;
    }


    .atributo-nome {
      font-size: 0.8rem;
      color: #ccc;
      text-transform: uppercase;
    }


    /* Ações do Card */
    .card-actions {
      display: flex;
      gap: 10px;
      margin-top: auto;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }


    .btn-acao {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 0.9rem;
    }


    .btn-editar {
      background: rgba(255, 140, 0, 0.2);
      color: #ff8c00;
      border: 1px solid rgba(255, 140, 0, 0.3);
    }


    .btn-editar:hover {
      background: rgba(255, 140, 0, 0.3);
    }


    .btn-resumo {
      background: rgba(46, 125, 50, 0.2);
      color: #4CAF50;
      border: 1px solid rgba(76, 175, 80, 0.3);
    }


    .btn-resumo:hover {
      background: rgba(76, 175, 80, 0.3);
    }


    .btn-excluir {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
      border: 1px solid rgba(231, 76, 60, 0.3);
    }


    .btn-excluir:hover {
      background: rgba(231, 76, 60, 0.3);
    }


    /* Estado Vazio */
    .empty-state {
      text-align: center;
      padding: 80px 20px;
      color: #888;
    }


    .empty-state i {
      font-size: 5rem;
      margin-bottom: 20px;
      color: #555;
    }


    .empty-state h3 {
      font-size: 1.8rem;
      margin-bottom: 15px;
      color: #ccc;
    }


    .empty-state p {
      margin-bottom: 25px;
      font-size: 1.1rem;
      max-width: 500px;
      margin-left: auto;
      margin-right: auto;
    }


    /* Responsividade */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }


      .page-header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
      }


      .personagens-grid {
        grid-template-columns: 1fr;
        gap: 20px;
      }


      .personagem-card {
        padding: 20px;
      }


      .card-topo {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }


      .personagem-foto {
        width: 120px;
        height: 120px;
      }


      .personagem-info {
        grid-template-columns: 1fr;
        gap: 10px;
      }


      .atributos-rapidos {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
      }


      .card-actions {
        flex-direction: column;
        gap: 8px;
      }


      .btn-acao {
        width: 100%;
      }
    }


    @media (max-width: 480px) {
      .main-content {
        padding: 0 15px;
      }


      .page-title {
        font-size: 1.6rem;
      }


      .personagem-nome {
        font-size: 1.3rem;
      }


      .atributo-valor {
        font-size: 1.2rem;
      }


      .empty-state i {
        font-size: 4rem;
      }


      .empty-state h3 {
        font-size: 1.4rem;
      }
    }


    /* Tablet */
    @media (min-width: 769px) and (max-width: 1024px) {
      .personagens-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }


    /* Loading States */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 100px 20px;
      grid-column: 1 / -1;
    }


    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 140, 0, 0.3);
      border-left: 4px solid #ff8c00;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }


    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }


    /* Modal de Confirmação */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }


    .modal {
      background: rgba(30, 30, 40, 0.95);
      border-radius: 15px;
      padding: 30px;
      border: 1px solid rgba(255, 140, 0, 0.3);
      max-width: 400px;
      width: 90%;
      text-align: center;
    }


    .modal h3 {
      color: #ffd700;
      margin-bottom: 15px;
    }


    .modal p {
      margin-bottom: 25px;
      color: #ccc;
    }


    .modal-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
    }


    .btn-confirmar {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }


    .btn-cancelar {
      background: rgba(255, 255, 255, 0.1);
      color: #ccc;
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }


    .btn-confirmar:hover {
      background: #c0392b;
    }


    .btn-cancelar:hover {
      background: rgba(255, 255, 255, 0.2);
    }


    /* Notificação */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      background: rgba(30, 30, 40, 0.95);
      border-left: 4px solid #ff8c00;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1001;
      animation: slideIn 0.3s ease;
    }


    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }


    .notification.success {
      border-left-color: #27ae60;
    }


    .notification.error {
      border-left-color: #e74c3c;
    }
    /* GRID RESPONSIVO */
.characters-list {
 display: grid;
 grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
 gap: 20px;
 margin-top: 20px;
}


/* CARD COMPACTO */
.character-item {
 background: rgba(40, 40, 50, 0.8);
 border-radius: 12px;
 padding: 20px;
 border: 1px solid rgba(255, 140, 0, 0.2);
 transition: all 0.3s ease;
 display: flex;
 flex-direction: column;
 height: 100%;
 min-height: 220px;
}


.character-item:hover {
 transform: translateY(-3px);
 border-color: rgba(255, 140, 0, 0.5);
 box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}


/* STATUS BADGES */
.status-badge {
 padding: 4px 12px;
 border-radius: 20px;
 font-size: 0.8rem;
 font-weight: 600;
 display: inline-block;
}


.status-active {
 background: rgba(46, 204, 113, 0.2);
 color: #2ecc71;
 border: 1px solid rgba(46, 204, 113, 0.3);
}


.status-pending {
 background: rgba(241, 196, 15, 0.2);
 color: #f1c40f;
 border: 1px solid rgba(241, 196, 15, 0.3);
}


.status-inactive {
 background: rgba(149, 165, 166, 0.2);
 color: #95a5a6;
 border: 1px solid rgba(149, 165, 166, 0.3);
}


/* BOTÕES COMPACTOS */
.character-actions {
 display: flex;
 gap: 10px;
 margin-top: auto;
}


.btn-small {
 padding: 10px 15px;
 font-size: 0.9rem;
 border-radius: 6px;
 border: none;
 cursor: pointer;
 display: flex;
 align-items: center;
 justify-content: center;
 gap: 6px;
 transition: all 0.3s ease;
 flex: 1;
}


.btn-ver {
 background: rgba(52, 152, 219, 0.2);
 color: #3498db;
 border: 1px solid rgba(52, 152, 219, 0.3);
}


.btn-ver:hover {
 background: rgba(52, 152, 219, 0.3);
}


.btn-recusar {
 background: rgba(231, 76, 60, 0.2);
 color: #e74c3c;
 border: 1px solid rgba(231, 76, 60, 0.3);
}


.btn-recusar:hover {
 background: rgba(231, 76, 60, 0.3);
}


/* PENDING LIST - TAMBÉM MAIS COMPACTA */
.pending-list {
 display: grid;
 grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
 gap: 20px;
}


.pending-item {
 background: rgba(40, 40, 50, 0.8);
 border-radius: 12px;
 padding: 20px;
 border-left: 4px solid #f1c40f;
}


/* RESPONSIVIDADE */
@media (max-width: 768px) {
 .characters-list,
 .pending-list {
  grid-template-columns: 1fr;
  gap: 15px;
 }

 .character-item {
  padding: 15px;
 }

 .character-actions {
  flex-direction: column;
 }

 .btn-small {
  width: 100%;
 }
}


@media (min-width: 769px) and (max-width: 1024px) {
 .characters-list,
 .pending-list {
  grid-template-columns: repeat(2, 1fr);
 }
}


@media (min-width: 1025px) {
 .characters-list,
 .pending-list {
  grid-template-columns: repeat(3, 1fr);
 }
}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <h1>RPG SYSTEM</h1>
      </div>
      <div class="user-menu">
        <a href="home.html" class="btn-voltar">
          <i class="fas fa-arrow-left"></i>
          Voltar para Home
        </a>
      </div>
    </div>
  </header>


  <!-- Main Content -->
  <main class="main-content">
    <div class="page-header">
      <h1 class="page-title">Meus Personagens</h1>
      <button class="btn-novo-personagem" id="btnNovoPersonagem" onclick="criarNovoPersonagem()">
        <i class="fas fa-plus"></i>
        Novo Personagem
      </button>
    </div>


    <!-- Grid de Personagens -->
    <div class="personagens-grid" id="personagensGrid">
      <div class="loading">
        <div class="spinner"></div>
      </div>
    </div>


    <!-- Estado Vazio -->
    <div class="empty-state" id="emptyState" style="display: none;">
      <i class="fas fa-users"></i>
      <h3>Nenhum Personagem Criado</h3>
      <p>Comece sua aventura criando seu primeiro personagem!</p>
      <button class="btn-novo-personagem" onclick="criarNovoPersonagem()">
        <i class="fas fa-plus"></i>
        Criar Primeiro Personagem
      </button>
    </div>
  </main>


  <!-- Modal de Confirmação -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <h3>Excluir Personagem</h3>
      <p>Tem certeza que deseja excluir <strong id="personagemNomeExcluir">este personagem</strong>?</p>
      <p style="color: #e74c3c; font-size: 0.9rem;">Esta ação não pode ser desfeita!</p>
      <div class="modal-actions">
        <button class="btn-confirmar" id="btnConfirmarExcluir">Excluir</button>
        <button class="btn-cancelar" id="btnCancelarExcluir">Cancelar</button>
      </div>
    </div>
  </div>


  <script>
  // CONFIGURAÇÃO DO SUPABASE
const SUPABASE_URL = 'https://pujufdfhaxveuytkneqw.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1anVmZGZoYXh2ZXV5dGtuZXF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNTkyODksImV4cCI6MjA3OTkzNTI4OX0.mzOwsmf8qIQ4HZqnXLEmq4D7M6fz4VH1YWpWP-BsFvc';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let currentUser = null;


// VARIÁVEL GLOBAL PARA CAMPANHAS
window.campaignsData = [];


document.addEventListener('DOMContentLoaded', async function() {
 // Verificar autenticação
 const { data: { session } } = await supabase.auth.getSession();
 if (!session) {
  window.location.href = 'login.html';
  return;
 }
 currentUser = session.user;

 console.log('Usuário logado:', currentUser.email);

 // Configurar botões
 document.getElementById('btnVoltar').addEventListener('click', () => {
  window.location.href = 'campanhas.html';
 });

 document.getElementById('btnSair').addEventListener('click', async () => {
  if (confirm('Tem certeza que deseja sair?')) {
   await supabase.auth.signOut();
   window.location.href = 'login.html';
  }
 });

 // Configurar tabs
 setupTabs();

 // Carregar dashboard inicial
 await loadDashboard();
});


// CONFIGURAR TABS
function setupTabs() {
 document.querySelectorAll('.gm-tab').forEach(tab => {
  tab.addEventListener('click', function() {
   const tabId = this.getAttribute('data-tab');
   
   // Remover active de todas
   document.querySelectorAll('.gm-tab').forEach(t => t.classList.remove('active'));
   document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
   
   // Adicionar active na selecionada
   this.classList.add('active');
   document.getElementById(tabId + '-tab').classList.add('active');
   
   // Se for a tab de PCs, carregar campanhas no seletor
   if (tabId === 'pcs') {
    loadCampaignsToSelector();
   }
  });
 });
}


// CARREGAR DASHBOARD
async function loadDashboard() {
 try {
  console.log('Carregando campanhas do GM...');
  
  // Buscar campanhas onde o usuário é GM
  const { data: campaigns, error } = await supabase
   .from('campaigns')
   .select('*')
   .eq('gm_id', currentUser.id)
   .order('created_at', { ascending: false });
  
  if (error) {
   console.error('Erro ao buscar campanhas:', error);
   throw error;
  }
  
  console.log('Campanhas encontradas:', campaigns);
  
  const campaignsList = document.getElementById('campaignsList');
  
  if (!campaigns || campaigns.length === 0) {
   campaignsList.innerHTML = `
    <div class="empty-state">
     <i class="fas fa-campground"></i>
     <h3>Nenhuma Campanha</h3>
     <p>Você ainda não criou nenhuma campanha como Mestre.</p>
     <button class="btn" onclick="window.location.href='criar-campanha.html'">
      <i class="fas fa-plus"></i> Criar Primeira Campanha
     </button>
    </div>
   `;
   return;
  }
  
  // Mostrar campanhas
  campaignsList.innerHTML = `
   <div class="campaigns-list">
    ${campaigns.map(camp => `
     <div class="campaign-item">
      <div class="campaign-header">
       <div class="campaign-name">${escapeHtml(camp.name)}</div>
       <div class="campaign-code">${camp.campaign_id || camp.id.substring(0, 8)}</div>
      </div>
      <div class="campaign-stats">
       <div><i class="fas fa-user"></i> Mestre: Você</div>
       <div><i class="fas fa-scroll"></i> Cenário: ${camp.scenario || 'Fantasy'}</div>
       <div><i class="fas fa-bolt"></i> Pontos: ${camp.points || '100'} pts</div>
       <div><i class="fas fa-chart-bar"></i> Status: <span class="status-badge status-${camp.status || 'active'}">${camp.status || 'Ativa'}</span></div>
      </div>
      <div class="campaign-actions">
       <button class="btn btn-small btn-gerenciar" onclick="selectCampaignForManagement('${camp.id}', '${escapeHtml(camp.name)}')">
        <i class="fas fa-users"></i> Gerenciar Personagens
       </button>
       <button class="btn btn-small" onclick="viewCampaignDetails('${camp.id}')">
        <i class="fas fa-eye"></i> Ver Campanha
       </button>
      </div>
     </div>
    `).join('')}
   </div>
  `;
  
  // Salvar campanhas para usar no seletor
  window.campaignsData = campaigns;
  
 } catch (error) {
  console.error('Erro no dashboard:', error);
  document.getElementById('campaignsList').innerHTML = `
   <div class="empty-state">
    <i class="fas fa-exclamation-triangle"></i>
    <h3>Erro ao Carregar</h3>
    <p>${error.message}</p>
    <button class="btn" onclick="loadDashboard()">
     <i class="fas fa-redo"></i> Tentar Novamente
    </button>
   </div>
  `;
 }
}


// CARREGAR CAMPANHAS NO SELECTOR
function loadCampaignsToSelector() {
 const selector = document.getElementById('selectedCampaign');

 if (!window.campaignsData || window.campaignsData.length === 0) {
  selector.innerHTML = '<option value="">Nenhuma campanha disponível</option>';
  return;
 }

 selector.innerHTML = '<option value="">Selecione uma campanha...</option>';
 window.campaignsData.forEach(camp => {
  const option = document.createElement('option');
  option.value = camp.id;
  option.textContent = `${camp.name} (${camp.campaign_id || camp.id.substring(0, 8)})`;
  selector.appendChild(option);
 });

 // Configurar evento de mudança
 selector.onchange = function() {
  if (this.value) {
   const campaign = window.campaignsData.find(c => c.id === this.value);
   if (campaign) {
    loadCharactersForCampaign(campaign.id, campaign.name);
   }
  } else {
   resetCharacterLists();
  }
 };
}


// SELECIONAR CAMPANHA PARA GERENCIAMENTO
function selectCampaignForManagement(campaignId, campaignName) {
 // Ir para tab de PCs
 document.querySelector('[data-tab="dashboard"]').classList.remove('active');
 document.querySelector('[data-tab="pcs"]').classList.add('active');

 document.getElementById('dashboard-tab').classList.remove('active');
 document.getElementById('pcs-tab').classList.add('active');

 // Selecionar no dropdown
 const selector = document.getElementById('selectedCampaign');
 selector.value = campaignId;

 // Carregar personagens
 loadCharactersForCampaign(campaignId, campaignName);
}


// FUNÇÃO PRINCIPAL - CARREGAR PERSONAGENS DA CAMPANHA
async function loadCharactersForCampaign(campaignId, campaignName) {
 console.log(` Buscando personagens da campanha: ${campaignName}`);

 try {
  // Mostrar loading
  document.getElementById('pendingList').innerHTML = `
   <div style="text-align: center; padding: 30px;">
    <div class="spinner"></div>
    <p>Buscando vínculos...</p>
   </div>
  `;
  
  document.getElementById('charactersList').innerHTML = `
   <div style="text-align: center; padding: 40px;">
    <div class="spinner"></div>
    <p>Carregando personagens...</p>
   </div>
  `;
  
  // 1. BUSCAR VÍNCULOS DA TABELA campaign_characters
  console.log(' Buscando em campaign_characters...');
  const { data: vinculos, error: errorVinculos } = await supabase
   .from('campaign_characters')
   .select('*')
   .eq('campaign_id', campaignId);
  
  if (errorVinculos) {
   console.error('Erro ao buscar vínculos:', errorVinculos);
   throw errorVinculos;
  }
  
  console.log('✅ Vínculos encontrados:', vinculos);
  
  if (!vinculos || vinculos.length === 0) {
   showNoCharactersFound(campaignId);
   return;
  }
  
  // 2. SEPARAR PENDENTES E ATIVOS
  const pendentes = vinculos.filter(v => !v.user_id);
  const ativos = vinculos.filter(v => v.user_id);
  
  console.log(` Pendentes: ${pendentes.length}, Ativos: ${ativos.length}`);
  
  // 3. MOSTRAR VÍNCULOS PENDENTES
  showPendingLinks(pendentes);
  
  // 4. BUSCAR E MOSTRAR PERSONAGENS VINCULADOS
  if (ativos.length > 0) {
   await showLinkedCharacters(ativos);
  } else {
   document.getElementById('charactersList').innerHTML = `
    <div class="empty-state">
     <i class="fas fa-users-slash"></i>
     <p>Nenhum personagem vinculado ainda.</p>
     <button class="btn btn-small" onclick="generateInviteLink('${campaignId}')" style="margin-top: 10px;">
      <i class="fas fa-link"></i> Gerar Link de Convite
     </button>
    </div>
   `;
  }
  
 } catch (error) {
  console.error('❌ Erro ao carregar personagens:', error);
  showError(error);
 }
}


// MOSTRAR VÍNCULOS PENDENTES
function showPendingLinks(pendentes) {
 if (pendentes.length > 0) {
  document.getElementById('pendingList').innerHTML = `
   <div class="pending-list">
    ${pendentes.map(v => `
     <div class="pending-item">
      <div class="item-header">
       <div class="player-name">
        <i class="fas fa-user-clock"></i> Vínculo Disponível
       </div>
       <div class="campaign-code">
        ID: ${v.character_id ? v.character_id.substring(0, 8) + '...' : 'Sem ID'}
       </div>
      </div>
      <div style="margin: 10px 0; color: #ccc; font-size: 0.9rem;">
       <i class="fas fa-info-circle"></i> Aguardando jogador
      </div>
      <div class="pending-actions">
       <button class="btn btn-small btn-aceitar" onclick="assignPlayerToLink('${v.id}')">
        <i class="fas fa-user-plus"></i> Atribuir Jogador
       </button>
       <button class="btn btn-small btn-recusar" onclick="deleteLink('${v.id}')">
        <i class="fas fa-trash"></i> Remover
       </button>
      </div>
     </div>
    `).join('')}
   </div>
  `;
 } else {
  document.getElementById('pendingList').innerHTML = `
   <div class="empty-state">
    <i class="fas fa-check-circle"></i>
    <p>Nenhum vínculo pendente.</p>
   </div>
  `;
 }
}


// BUSCAR E MOSTRAR PERSONAGENS VINCULADOS - VERSÃO SIMPLIFICADA
async function showLinkedCharacters(vinculosAtivos) {
 // Pegar IDs dos personagens
 const characterIds = vinculosAtivos.map(v => v.character_id).filter(id => id);

 console.log(' IDs dos personagens na campanha:', characterIds);

 if (characterIds.length === 0) {
  document.getElementById('charactersList').innerHTML = `
   <div class="empty-state">
    <i class="fas fa-users-slash"></i>
    <p>Nenhum personagem vinculado ainda.</p>
   </div>
  `;
  return;
 }

 // BUSCAR DADOS REAIS DOS PERSONAGENS
 try {
  console.log(' Buscando dados REAIS dos personagens...');
  const { data: charactersFound, error } = await supabase
   .from('characters')
   .select(`
    id,
    nome,
    raca,
    classe,
    forca,
    destreza,
    inteligencia,
    saude,
    pontos_totais,
    pontos_gastos,
    pontos_disponiveis,
    status
   `)
   .in('id', characterIds);
  
  if (error) {
   console.error('Erro ao buscar personagens:', error);
   throw error;
  }
  
  console.log(`✅ Encontrados ${charactersFound.length} personagens com dados reais:`, charactersFound);
  
  // BUSCAR NICKNAMES DOS JOGADORES
  const userIds = vinculosAtivos.map(v => v.user_id).filter(id => id);
  let userNicknames = {};
  
  if (userIds.length > 0) {
   try {
    const { data: users, error: usersError } = await supabase
     .from('profiles')
     .select('id, nickname, email')
     .in('id', userIds);
    
    if (!usersError && users) {
     users.forEach(user => {
      const nickname = user.nickname ||
               user.email?.split('@')[0] ||
               user.id.substring(0, 6);
      userNicknames[user.id] = nickname;
     });
    }
   } catch (err) {
    console.log('⚠️ Erro ao buscar nicknames:', err);
   }
   
   // Fallback para IDs sem nickname
   userIds.forEach(userId => {
    if (!userNicknames[userId]) {
     userNicknames[userId] = userId.substring(0, 6);
    }
   });
  }
  
  // MOSTRAR PERSONAGENS COM LAYOUT COMPACTO
  displayCharactersCompact(charactersFound, vinculosAtivos, userNicknames);
  
 } catch (error) {
  console.error('❌ Erro ao buscar dados dos personagens:', error);
  document.getElementById('charactersList').innerHTML = `
   <div style="color: #e74c3c; text-align: center; padding: 40px;">
    <i class="fas fa-exclamation-triangle"></i>
    <h3>Erro ao Carregar Personagens</h3>
    <p>${error.message}</p>
   </div>
  `;
 }
}


// MOSTRAR PERSONAGENS COM LAYOUT COMPACTO (2-3 COLUNAS)
function displayCharactersCompact(characters, vinculos, nicknames) {
 if (!characters || characters.length === 0) {
  document.getElementById('charactersList').innerHTML = `
   <div class="empty-state">
    <i class="fas fa-users-slash"></i>
    <p>Nenhum personagem encontrado.</p>
   </div>
  `;
  return;
 }

 const charactersList = document.getElementById('charactersList');

 charactersList.innerHTML = `
  <div class="characters-list">
   ${characters.map(char => {
    // Encontrar o vínculo correspondente
    const vinculo = vinculos.find(v => v.character_id === char.id);
    const jogadorNickname = vinculo && vinculo.user_id ?
                nicknames[vinculo.user_id] :
                'Desconhecido';
    
    // Dados do personagem
    const nome = escapeHtml(char.nome || `Personagem ${char.id.substring(0, 8)}`);
    const raca = escapeHtml(char.raca || 'Sem Raça');
    const classe = escapeHtml(char.classe || 'Sem Classe');
    
    // Pontos reais do banco
    const pontosTotais = char.pontos_totais || 150;
    const pontosGastos = char.pontos_gastos || 0;
    const pontosDisponiveis = char.pontos_disponiveis || (pontosTotais - pontosGastos);
    
    // Status
    const status = char.status || 'Ativo';
    
    return `
     <div class="character-item">
      <!-- CABEÇALHO -->
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
       <div>
        <div style="font-size: 1.1rem; font-weight: 600; color: #ffd700; margin-bottom: 5px;">
         ${nome}
        </div>
        <div style="font-size: 0.9rem; color: #ff8c00;">
         ${raca} • ${classe}
        </div>
       </div>
       <div class="status-badge status-active">${status}</div>
      </div>
      
      <!-- PONTOS -->
      <div style="margin: 10px 0; padding: 10px; background: rgba(255, 140, 0, 0.1); border-radius: 6px;">
       <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
        <span style="color: #ccc; font-size: 0.9rem;">
         <i class="fas fa-coins"></i> Pontos
        </span>
        <span style="font-weight: 600; color: #ffd700;">
         ${pontosDisponiveis}/${pontosTotais}
        </span>
       </div>
       ${pontosGastos > 0 ? `
        <div style="font-size: 0.85rem; color: #aaa;">
         Gastos: ${pontosGastos} pontos
        </div>
       ` : ''}
      </div>
      
      <!-- VÍNCULO COM JOGADOR -->
      ${vinculo ? `
       <div style="margin: 10px 0; padding: 8px; background: rgba(52, 152, 219, 0.1); border-radius: 4px; font-size: 0.9rem;">
        <i class="fas fa-user"></i> Jogador:
        <strong>${jogadorNickname}</strong>
       </div>
      ` : ''}
      
      <!-- AÇÕES -->
      <div class="character-actions" style="display: flex; gap: 10px; margin-top: 15px;">
       <button class="btn btn-small btn-ver" onclick="viewCharacterSheet('${char.id}')" style="flex: 1;">
        <i class="fas fa-scroll"></i> Ver Ficha
       </button>
       <button class="btn btn-small btn-recusar" onclick="removeFromCampaign('${vinculo ? vinculo.id : char.id}', '${escapeHtml(nome)}')" style="flex: 1;">
        <i class="fas fa-user-minus"></i> Remover
       </button>
      </div>
     </div>
    `;
   }).join('')}
  </div>
 `;
}


// FUNÇÕES DE AÇÃO
async function assignPlayerToLink(linkId) {
 const playerEmail = prompt('Digite o email do jogador para vincular:');
 if (!playerEmail) return;

 try {
  // Buscar ID do usuário pelo email
  const { data: users, error } = await supabase
   .from('profiles')
   .select('id')
   .eq('email', playerEmail)
   .single();
  
  if (error || !users) {
   alert('Jogador não encontrado!');
   return;
  }
  
  // Atualizar vínculo
  const { error: updateError } = await supabase
   .from('campaign_characters')
   .update({
    user_id: users.id,
    updated_at: new Date().toISOString()
   })
   .eq('id', linkId);
  
  if (updateError) throw updateError;
  
  alert('Jogador vinculado com sucesso!');
  location.reload();
 } catch (error) {
  console.error('Erro ao vincular jogador:', error);
  alert('Erro: ' + error.message);
 }
}


async function deleteLink(linkId) {
 if (!confirm('Remover este vínculo?')) return;

 try {
  const { error } = await supabase
   .from('campaign_characters')
   .delete()
   .eq('id', linkId);
  
  if (error) throw error;
  
  alert('Vínculo removido!');
  location.reload();
 } catch (error) {
  alert('Erro ao remover: ' + error.message);
 }
}


async function removeFromCampaign(linkId, charName) {
 if (!confirm(`Remover "${charName}" da campanha?`)) return;

 try {
  const { error } = await supabase
   .from('campaign_characters')
   .delete()
   .eq('id', linkId);
  
  if (error) throw error;
  
  alert('Personagem removido da campanha!');
  location.reload();
 } catch (error) {
  alert('Erro: ' + error.message);
 }
}


// VER FICHA - ABRE A ABA RESUMO DO PERSONAGEM
function viewCharacterSheet(characterId) {
 // Abre criar-personagens.html na aba de resumo
 window.open(`criar-personagens.html?id=${characterId}`, '_blank');
}


function viewCampaignDetails(campaignId) {
 window.open(`campanha.html?id=${campaignId}`, '_blank');
}


function generateInviteLink(campaignId) {
 const campaign = window.campaignsData.find(c => c.id === campaignId);
 if (!campaign) return;

 const link = `${window.location.origin}/entrar-campanha.html?code=${campaign.campaign_id}`;

 alert(`Link de convite para "${campaign.name}":\n\n${link}\n\nCompartilhe com seus jogadores!`);

 if (navigator.clipboard) {
  navigator.clipboard.writeText(link);
  alert('Link copiado para a área de transferência!');
 }
}


// FUNÇÕES AUXILIARES
function showNoCharactersFound(campaignId) {
 document.getElementById('pendingList').innerHTML = `
  <div class="empty-state">
   <i class="fas fa-search"></i>
   <p>Nenhum vínculo encontrado.</p>
  </div>
 `;

 document.getElementById('charactersList').innerHTML = `
  <div class="empty-state">
   <i class="fas fa-users-slash"></i>
   <h3>Nenhum Personagem</h3>
   <p>Esta campanha não tem personagens vinculados ainda.</p>
   <div style="margin-top: 20px;">
    <button class="btn" onclick="generateInviteLink('${campaignId}')">
     <i class="fas fa-user-plus"></i> Convidar Jogadores
    </button>
   </div>
  </div>
 `;
}


function showError(error) {
 document.getElementById('pendingList').innerHTML = `
  <div style="color: #e74c3c; text-align: center; padding: 20px;">
   <i class="fas fa-exclamation-triangle"></i>
   <p>Erro ao carregar vínculos</p>
  </div>
 `;

 document.getElementById('charactersList').innerHTML = `
  <div style="color: #e74c3c; text-align: center; padding: 40px;">
   <i class="fas fa-exclamation-triangle"></i>
   <h3>Erro</h3>
   <p>${error.message}</p>
   <div style="margin-top: 20px;">
    <button class="btn btn-small" onclick="checkDatabaseStructure()">
     <i class="fas fa-database"></i> Verificar Banco
    </button>
    <button class="btn btn-small" onclick="loadDashboard()" style="margin-left: 10px;">
     <i class="fas fa-redo"></i> Recarregar
    </button>
   </div>
  </div>
 `;
}


function resetCharacterLists() {
 document.getElementById('pendingList').innerHTML = `
  <div class="empty-state">
   <i class="fas fa-clock"></i>
   <p>Selecione uma campanha para ver vínculos pendentes</p>
  </div>
 `;

 document.getElementById('charactersList').innerHTML = `
  <div class="empty-state">
   <i class="fas fa-users"></i>
   <p>Selecione uma campanha para ver personagens vinculados</p>
  </div>
 `;
}


async function checkDatabaseStructure() {
 try {
  alert('Verificando tabelas...\n\n1. campaign_characters - OK\n2. characters - Verificando...\n\nOs vínculos existem, mas os personagens podem estar na tabela characters ou player_characters.');
  
  // Verificar tabela characters
  const { data, error } = await supabase
   .from('characters')
   .select('id, nome')
   .limit(2);
  
  if (error) {
   alert(`Tabela characters: ${error.message}\n\nOs personagens podem estar na tabela "player_characters".`);
  } else {
   alert(`Tabela characters existe com ${data ? data.length : 0} registros.\n\nExemplo: ${data.length > 0 ? data[0].nome : 'Nenhum'}`);
  }
 } catch (err) {
  alert('Erro na verificação: ' + err.message);
 }
}


// FUNÇÃO PARA ESCAPAR HTML
function escapeHtml(text) {
 if (!text) return '';
 const div = document.createElement('div');
 div.textContent = text;
 return div.innerHTML;
}
/* ==================== */
/* NOVO CSS PARA CARDS COMPACTOS */
/* ==================== */



</script>
</body>
</html>
