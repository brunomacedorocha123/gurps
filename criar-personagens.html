<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Criar Personagem - RPG System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- No head do criar-personagem.html -->
<link rel="stylesheet" href="style-atributos.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('Cris2.jpg') no-repeat center center fixed;
            background-size: cover;
            color: #fff;
            min-height: 100vh;
        }

        /* Header do Personagem */
        .char-header {
            background: rgba(30, 30, 40, 0.9);
            padding: 15px 20px;
            border-bottom: 2px solid rgba(255, 140, 0, 0.3);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .char-header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .char-name-section {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .char-name-input {
            background: transparent;
            border: none;
            color: #ffd700;
            font-size: 1.5rem;
            font-weight: bold;
            padding: 8px 12px;
            border-bottom: 2px solid rgba(255, 140, 0, 0.3);
            min-width: 250px;
            max-width: 400px;
        }

        .char-name-input:focus {
            outline: none;
            border-color: #ff8c00;
        }

        .char-actions {
            display: flex;
            gap: 12px;
        }

        .btn-header {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .btn-salvar {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-excluir {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .btn-sair {
            background: rgba(255, 255, 255, 0.1);
            color: #ccc;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-header:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* Navegação de Abas */
        .char-tabs {
            background: rgba(20, 20, 30, 0.8);
            border-bottom: 1px solid rgba(255, 140, 0, 0.2);
            overflow-x: auto;
            position: sticky;
            top: 80px;
            z-index: 99;
        }

        .tabs-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 5px;
            padding: 0 20px;
        }

        .tab-btn {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: #ccc;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }

        .tab-btn:hover {
            color: #ff8c00;
            background: rgba(255, 140, 0, 0.1);
        }

        .tab-btn.active {
            color: #ffd700;
            border-bottom-color: #ff8c00;
            background: rgba(255, 140, 0, 0.1);
        }

        /* Conteúdo das Abas */
        .char-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .char-header-content {
                flex-direction: column;
                gap: 15px;
            }

            .char-name-section {
                width: 100%;
                justify-content: center;
            }

            .char-name-input {
                min-width: 200px;
                font-size: 1.3rem;
                text-align: center;
            }

            .char-actions {
                width: 100%;
                justify-content: center;
            }

            .btn-header {
                padding: 8px 15px;
                font-size: 0.9rem;
            }

            .tabs-container {
                padding: 0 10px;
                gap: 2px;
            }

            .tab-btn {
                padding: 10px 12px;
                font-size: 0.8rem;
            }

            .tab-btn i {
                display: none;
            }
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 140, 0, 0.3);
            border-left: 4px solid #ff8c00;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header do Personagem -->
    <header class="char-header">
        <div class="char-header-content">
            <div class="char-name-section">
                <input type="text" id="charName" class="char-name-input" placeholder="Nome do Personagem" value="Novo Personagem">
            </div>
            <div class="char-actions">
                <button class="btn-header btn-salvar" id="btnSalvar">
                    <i class="fas fa-save"></i>
                    Salvar
                </button>
                <button class="btn-header btn-excluir" id="btnExcluir">
                    <i class="fas fa-trash"></i>
                    Excluir
                </button>
                <button class="btn-header btn-sair" id="btnSair">
                    <i class="fas fa-sign-out-alt"></i>
                    Sair
                </button>
            </div>
        </div>
    </header>

    <!-- Navegação de Abas -->
    <nav class="char-tabs">
        <div class="tabs-container">
            <button class="tab-btn active" data-tab="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                Dashboard
            </button>
            <button class="tab-btn" data-tab="atributos">
                <i class="fas fa-dumbbell"></i>
                Atributos
            </button>
            <button class="tab-btn" data-tab="caracteristicas">
                <i class="fas fa-user-tie"></i>
                Características
            </button>
            <button class="tab-btn" data-tab="vantagens">
                <i class="fas fa-star"></i>
                Vantagens
            </button>
            <button class="tab-btn" data-tab="pericias">
                <i class="fas fa-graduation-cap"></i>
                Perícias
            </button>
            <button class="tab-btn" data-tab="tecnicas">
                <i class="fas fa-fist-raised"></i>
                Técnicas
            </button>
            <button class="tab-btn" data-tab="magias">
                <i class="fas fa-hat-wizard"></i>
                Magias
            </button>
            <button class="tab-btn" data-tab="equipamento">
                <i class="fas fa-backpack"></i>
                Equipamento
            </button>
            <button class="tab-btn" data-tab="resumo">
                <i class="fas fa-file-alt"></i>
                Resumo
            </button>
        </div>
    </nav>

    <!-- Conteúdo das Abas -->
    <main class="char-content">
        
        <!-- ABA DASHBOARD -->
        <div id="dashboard" class="tab-content active">
            <div class="loading">
                <div class="spinner"></div>
            </div>
            <!-- Conteúdo será preenchido via JavaScript -->
        </div>

       <!-- ABA ATRIBUTOS -->
<div id="atributos" class="tab-content">
    <div class="atributos-container">
        <!-- Seção de Pontos -->
        <div class="pontos-section">
            <div class="ponto-card total">
                <h3>Pontos Totais</h3>
                <div class="ponto-valor" id="pontosTotais">150</div>
            </div>
            <div class="ponto-card gastos">
                <h3>Pontos Gastos</h3>
                <div class="ponto-valor" id="pontosGastos">0</div>
            </div>
            <div class="ponto-card saldo">
                <h3>Saldo Disponível</h3>
                <div class="ponto-valor" id="pontosSaldo">150</div>
            </div>
        </div>

        <!-- Atributos Principais -->
        <div class="atributos-principais">
            <h2 class="secao-titulo">Atributos Principais</h2>
            <div class="cards-grid principais-grid">
                <!-- ST -->
                <div class="atributo-card">
                    <div class="atributo-header">
                        <h3>FORÇA (ST)</h3>
                        <span class="custo-pontos" id="custoST">0</span>
                    </div>
                    <div class="atributo-controles">
                        <button class="btn-controle" onclick="alterarAtributo('ST', -1)">-</button>
                        <input type="number" id="ST" class="atributo-input" value="10" min="1" max="40">
                        <button class="btn-controle" onclick="alterarAtributo('ST', 1)">+</button>
                    </div>
                    <div class="atributo-desc">Custo: 10 pontos por nível</div>
                </div>

                <!-- DX -->
                <div class="atributo-card">
                    <div class="atributo-header">
                        <h3>DESTREZA (DX)</h3>
                        <span class="custo-pontos" id="custoDX">0</span>
                    </div>
                    <div class="atributo-controles">
                        <button class="btn-controle" onclick="alterarAtributo('DX', -1)">-</button>
                        <input type="number" id="DX" class="atributo-input" value="10" min="1" max="40">
                        <button class="btn-controle" onclick="alterarAtributo('DX', 1)">+</button>
                    </div>
                    <div class="atributo-desc">Custo: 20 pontos por nível</div>
                </div>

                <!-- IQ -->
                <div class="atributo-card">
                    <div class="atributo-header">
                        <h3>INTELIGÊNCIA (IQ)</h3>
                        <span class="custo-pontos" id="custoIQ">0</span>
                    </div>
                    <div class="atributo-controles">
                        <button class="btn-controle" onclick="alterarAtributo('IQ', -1)">-</button>
                        <input type="number" id="IQ" class="atributo-input" value="10" min="1" max="40">
                        <button class="btn-controle" onclick="alterarAtributo('IQ', 1)">+</button>
                    </div>
                    <div class="atributo-desc">Custo: 20 pontos por nível</div>
                </div>

                <!-- HT -->
                <div class="atributo-card">
                    <div class="atributo-header">
                        <h3>VIGOR (HT)</h3>
                        <span class="custo-pontos" id="custoHT">0</span>
                    </div>
                    <div class="atributo-controles">
                        <button class="btn-controle" onclick="alterarAtributo('HT', -1)">-</button>
                        <input type="number" id="HT" class="atributo-input" value="10" min="1" max="40">
                        <button class="btn-controle" onclick="alterarAtributo('HT', 1)">+</button>
                    </div>
                    <div class="atributo-desc">Custo: 10 pontos por nível</div>
                </div>
            </div>
        </div>

        <!-- Atributos Secundários -->
        <div class="atributos-secundarios">
            <h2 class="secao-titulo">Atributos Secundários</h2>
            <div class="cards-grid secundarios-grid">
                <!-- PV -->
                <div class="secundario-card">
                    <h3>PONTOS DE VIDA (PV)</h3>
                    <div class="secundario-base">
                        <span class="base-label">Base:</span>
                        <span class="base-valor" id="PVBase">10</span>
                    </div>
                    <div class="bonus-section">
                        <span class="bonus-label">Bônus/Redutor:</span>
                        <input type="number" id="bonusPV" class="bonus-input" value="0" min="-10" max="10">
                    </div>
                    <div class="secundario-total">
                        <span class="total-label">Total:</span>
                        <span class="total-valor" id="PVTotal">10</span>
                    </div>
                    <div class="secundario-desc">Baseado em ST</div>
                </div>

                <!-- PF -->
                <div class="secundario-card">
                    <h3>PONTOS DE FADIGA (PF)</h3>
                    <div class="secundario-base">
                        <span class="base-label">Base:</span>
                        <span class="base-valor" id="PFBase">10</span>
                    </div>
                    <div class="bonus-section">
                        <span class="bonus-label">Bônus/Redutor:</span>
                        <input type="number" id="bonusPF" class="bonus-input" value="0" min="-10" max="10">
                    </div>
                    <div class="secundario-total">
                        <span class="total-label">Total:</span>
                        <span class="total-valor" id="PFTotal">10</span>
                    </div>
                    <div class="secundario-desc">Baseado em HT</div>
                </div>

                <!-- Vontade -->
                <div class="secundario-card">
                    <h3>VONTADE</h3>
                    <div class="secundario-base">
                        <span class="base-label">Base:</span>
                        <span class="base-valor" id="VontadeBase">10</span>
                    </div>
                    <div class="bonus-section">
                        <span class="bonus-label">Bônus/Redutor:</span>
                        <input type="number" id="bonusVontade" class="bonus-input" value="0" min="-10" max="10">
                    </div>
                    <div class="secundario-total">
                        <span class="total-label">Total:</span>
                        <span class="total-valor" id="VontadeTotal">10</span>
                    </div>
                    <div class="secundario-desc">Baseado em IQ</div>
                </div>

                <!-- Percepção -->
                <div class="secundario-card">
                    <h3>PERCEPÇÃO</h3>
                    <div class="secundario-base">
                        <span class="base-label">Base:</span>
                        <span class="base-valor" id="PercepcaoBase">10</span>
                    </div>
                    <div class="bonus-section">
                        <span class="bonus-label">Bônus/Redutor:</span>
                        <input type="number" id="bonusPercepcao" class="bonus-input" value="0" min="-10" max="10">
                    </div>
                    <div class="secundario-total">
                        <span class="total-label">Total:</span>
                        <span class="total-valor" id="PercepcaoTotal">10</span>
                    </div>
                    <div class="secundario-desc">Baseado em IQ</div>
                </div>

                <!-- Deslocamento -->
                <div class="secundario-card">
                    <h3>DESLOCAMENTO</h3>
                    <div class="secundario-base">
                        <span class="base-label">Base:</span>
                        <span class="base-valor" id="DeslocamentoBase">5.00</span>
                    </div>
                    <div class="bonus-section">
                        <span class="bonus-label">Bônus/Redutor:</span>
                        <input type="number" id="bonusDeslocamento" class="bonus-input" value="0" min="-5" max="5" step="0.25">
                    </div>
                    <div class="secundario-total">
                        <span class="total-label">Total:</span>
                        <span class="total-valor" id="DeslocamentoTotal">5.00</span>
                    </div>
                    <div class="secundario-desc">(DX + HT) / 4</div>
                </div>
            </div>
        </div>

        <!-- Sistema de Combate -->
        <div class="combate-section">
            <h2 class="secao-titulo">Sistema de Combate</h2>
            <div class="cards-grid combate-grid">
                <!-- Dano Base -->
                <div class="combate-card">
                    <h3>DANO BÁSICO</h3>
                    <div class="dano-container">
                        <div class="dano-tipo">
                            <span class="dano-label">GDP:</span>
                            <span class="dano-valor" id="danoGDP">1d-2</span>
                        </div>
                        <div class="dano-tipo">
                            <span class="dano-label">GEB:</span>
                            <span class="dano-valor" id="danoGEB">1d</span>
                        </div>
                    </div>
                    <div class="combate-desc">Baseado em ST</div>
                </div>

                <!-- Níveis de Carga -->
                <div class="combate-card">
                    <h3>NÍVEIS DE CARGA</h3>
                    <div class="carga-container">
                        <div class="carga-item">
                            <span class="carga-label">Nenhuma:</span>
                            <span class="carga-valor" id="cargaNenhuma">10.0</span>
                        </div>
                        <div class="carga-item">
                            <span class="carga-label">Leve:</span>
                            <span class="carga-valor" id="cargaLeve">20.0</span>
                        </div>
                        <div class="carga-item">
                            <span class="carga-label">Média:</span>
                            <span class="carga-valor" id="cargaMedia">30.0</span>
                        </div>
                        <div class="carga-item">
                            <span class="carga-label">Pesada:</span>
                            <span class="carga-valor" id="cargaPesada">60.0</span>
                        </div>
                        <div class="carga-item">
                            <span class="carga-label">Muito Pesada:</span>
                            <span class="carga-valor" id="cargaMuitoPesada">100.0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
        <!-- ABA CARACTERÍSTICAS -->
        <div id="caracteristicas" class="tab-content">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- ABA VANTAGENS -->
        <div id="vantagens" class="tab-content">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- ABA PERÍCIAS -->
        <div id="pericias" class="tab-content">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- ABA TÉCNICAS -->
        <div id="tecnicas" class="tab-content">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- ABA MAGIAS -->
        <div id="magias" class="tab-content">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- ABA EQUIPAMENTO -->
        <div id="equipamento" class="tab-content">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- ABA RESUMO -->
        <div id="resumo" class="tab-content">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>

    </main>

    <script>
    // Configuração do Supabase
    const SUPABASE_URL = 'https://pujufdfhaxveuytkneqw.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1anVmZGZoYXh2ZXV5dGtuZXF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNTkyODksImV4cCI6MjA3OTkzNTI4OX0.mzOwsmf8qIQ4HZqnXLEmq4D7M6fz4VH1YWpWP-BsFvc';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Estado global do personagem
    let personagemAtual = {
        id: null,
        nome: 'Novo Personagem',
        pontos_totais: 150,
        pontos_gastos: 0,
        forca: 10,
        destreza: 10,
        inteligencia: 10,
        saude: 10,
    };

    // Inicialização
    document.addEventListener('DOMContentLoaded', function() {
        inicializarNavegacaoAbas();
        configurarEventListeners();
        carregarPersonagemDaURL();
    });

    // Navegação entre abas - CORRIGIDA
    function inicializarNavegacaoAbas() {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Remove active de todos
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                // Ativa a aba clicada
                this.classList.add('active');
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.add('active');
                
                // Carrega o conteúdo da aba se necessário
                carregarConteudoAba(tabId);
                
                // Inicializa os atributos se for a aba de atributos
                if (tabId === 'atributos' && typeof inicializarAtributos === 'function') {
                    setTimeout(() => {
                        inicializarAtributos();
                    }, 100);
                }
            });
        });
    }

    // Configurar event listeners
    function configurarEventListeners() {
        // Botões do header
        document.getElementById('btnSalvar').addEventListener('click', salvarPersonagem);
        document.getElementById('btnExcluir').addEventListener('click', solicitarExclusao);
        document.getElementById('btnSair').addEventListener('click', sairSemSalvar);
        
        // Nome do personagem
        document.getElementById('charName').addEventListener('input', function() {
            personagemAtual.nome = this.value;
        });
    }

    // Carregar personagem da URL (se estiver editando)
    function carregarPersonagemDaURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const personagemId = urlParams.get('id');
        
        if (personagemId) {
            carregarPersonagemExistente(personagemId);
        } else {
            // Novo personagem - carrega dashboard
            carregarConteudoAba('dashboard');
        }
    }

    // Carregar conteúdo da aba - CORRIGIDA
    function carregarConteudoAba(abaId) {
        const abaContent = document.getElementById(abaId);
        
        // Se já carregou, não carrega novamente
        if (abaContent.getAttribute('data-loaded') === 'true') {
            return;
        }

        // Para a aba de atributos, não substituir o conteúdo
        if (abaId === 'atributos') {
            abaContent.setAttribute('data-loaded', 'true');
            return;
        }

        // Para outras abas, simula carregamento
        setTimeout(() => {
            if (abaId !== 'atributos') {
                abaContent.innerHTML = `<h2>Conteúdo da aba ${abaId} em desenvolvimento</h2>
                                       <p>Esta funcionalidade será implementada em breve.</p>`;
                abaContent.setAttribute('data-loaded', 'true');
            }
        }, 500);
    }

    // Salvar personagem
    async function salvarPersonagem() {
        try {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (!session) {
                alert('Você precisa estar logado para salvar!');
                return;
            }

            // Atualiza os dados dos atributos antes de salvar
            if (typeof obterDadosAtributos === 'function') {
                const dadosAtributos = obterDadosAtributos();
                personagemAtual.forca = dadosAtributos.ST;
                personagemAtual.destreza = dadosAtributos.DX;
                personagemAtual.inteligencia = dadosAtributos.IQ;
                personagemAtual.saude = dadosAtributos.HT;
                personagemAtual.pontos_gastos = dadosAtributos.PontosGastos;
            }

            const dadosSalvar = {
                ...personagemAtual,
                user_id: session.user.id,
                updated_at: new Date().toISOString()
            };

            let resultado;
            if (personagemAtual.id) {
                // Atualizar existente
                resultado = await supabase
                    .from('characters')
                    .update(dadosSalvar)
                    .eq('id', personagemAtual.id);
            } else {
                // Criar novo
                resultado = await supabase
                    .from('characters')
                    .insert([dadosSalvar])
                    .select();
                
                if (resultado.data) {
                    personagemAtual.id = resultado.data[0].id;
                }
            }

            if (resultado.error) throw resultado.error;

            alert('Personagem salvo com sucesso!');
            window.location.href = 'personagens.html';

        } catch (error) {
            alert('Erro ao salvar personagem: ' + error.message);
        }
    }

    // Carregar personagem existente
    async function carregarPersonagemExistente(personagemId) {
        try {
            const { data: personagem, error } = await supabase
                .from('characters')
                .select('*')
                .eq('id', personagemId)
                .single();

            if (error) throw error;

            personagemAtual = personagem;
            document.getElementById('charName').value = personagem.nome;
            
            // Carrega os dados nos atributos se a função existir
            if (typeof carregarDadosAtributos === 'function') {
                carregarDadosAtributos({
                    ST: personagem.forca,
                    DX: personagem.destreza,
                    IQ: personagem.inteligencia,
                    HT: personagem.saude
                });
            }
            
        } catch (error) {
            alert('Erro ao carregar personagem');
        }
    }

    // Solicitar exclusão
    function solicitarExclusao() {
        if (confirm('Tem certeza que deseja excluir este personagem?\nEsta ação não pode ser desfeita!')) {
            excluirPersonagem();
        }
    }

    // Excluir personagem
    async function excluirPersonagem() {
        if (!personagemAtual.id) {
            // Personagem novo não salvo
            window.location.href = 'personagens.html';
            return;
        }

        try {
            const { error } = await supabase
                .from('characters')
                .delete()
                .eq('id', personagemAtual.id);

            if (error) throw error;

            alert('Personagem excluído com sucesso!');
            window.location.href = 'personagens.html';

        } catch (error) {
            alert('Erro ao excluir personagem');
        }
    }

    // Sair sem salvar
    function sairSemSalvar() {
        if (confirm('Sair sem salvar as alterações?')) {
            window.location.href = 'personagens.html';
        }
    }
</script>
    <!-- Antes do </body> do criar-personagem.html -->
<script src="atributos.js"></script>
</body>
</html>